<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة زيارات المطاعم لمطاعم نايف</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #D8334A;
            --secondary: #4AB9DC;
            --accent: #4AB9DC;
            --light: #E6F7FF;
            --dark: #2A6B8F;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #D8334A;
        }

        body {
            background: linear-gradient(135deg, #E6F7FF 0%, #B3E5FC 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 10px 10px;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
        }

        .logo h1 {
            font-size: 1.8rem;
        }

        .logo img {
            height: 50px;
            width: auto;
            border-radius: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab.active {
            background-color: var(--light);
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .nav-tab:hover:not(.active) {
            background-color: #f8f9fa;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(216, 51, 74, 0.2);
        }

        textarea {
            min-height: 45px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3A9AB9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #B52A3F;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border-right: 4px solid var(--primary);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #E6F7FF;
        }

        .report-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 4px solid var(--secondary);
        }

        .report-info h3 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .report-info p {
            color: #666;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 25px;
            border-right: 4px solid var(--secondary);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
            border-right: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .problem-item {
            background: #FFEBEE;
            border-right: 4px solid var(--danger);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .problem-item.resolved {
            background: #E8F5E9;
            border-right-color: var(--success);
        }

        .visit-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border-right: 4px solid var(--secondary);
        }

        .visit-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .visit-title {
            font-weight: bold;
            color: var(--primary);
        }

        .visit-date {
            color: #666;
            font-size: 0.9rem;
        }

        .visit-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            direction: rtl;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
        }

        .detail-value {
            color: #333;
            text-align: right;
            direction: rtl;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-right: 4px solid var(--primary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.4rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .whatsapp-modal {
            max-width: 400px;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: #666;
            border-top: 1px solid #eee;
            background: white;
            border-radius: 10px 10px 0 0;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: #E8F5E9;
            color: #4CAF50;
        }

        .badge-warning {
            background: #FFF3E0;
            color: #FF9800;
        }

        .badge-danger {
            background: #FFEBEE;
            color: #D8334A;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .manager-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 4px solid var(--secondary);
        }

        .restaurant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .restaurant-actions {
            display: flex;
            gap: 5px;
        }

        .report-table-container {
            overflow-x: auto;
        }

        .report-table {
            min-width: 1300px;
        }

        .problem-history {
            color: #666;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .tab-content.active,
            .tab-content.active * {
                visibility: visible;
            }
            .tab-content.active {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                padding: 0;
            }
            .filters, .nav-tabs, header, footer, .actions {
                display: none !important;
            }
            .report-header {
                box-shadow: none;
                border: 1px solid #ddd;
                margin-bottom: 10px;
            }
            .report-table-container {
                overflow: visible;
            }
            .report-table {
                min-width: auto;
                width: 100%;
            }
            .print-title {
                text-align: center;
                margin-bottom: 20px;
                font-size: 18px;
                font-weight: bold;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
        }

        @media (max-width: 768px) {
            .form-row, .filter-row {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .report-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .visit-details {
                grid-template-columns: 1fr;
            }
            
            .settings-actions {
                flex-direction: column;
            }
        }

        #loginOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:99999;}
        #loginBox{background:white;padding:22px;border-radius:8px;width:360px;max-width:90%;box-shadow:0 8px 24px rgba(0,0,0,0.3);direction:rtl;text-align:right}
        #loginBox h3{margin-bottom:12px;color:var(--primary)}
        #loginBox input{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:6px}
        #loginBox button{padding:10px 14px;border:none;border-radius:6px;cursor:pointer}
        #loginError{color:red;display:none;margin-top:8px}
        .user-action-btn{margin-left:6px}
        .manager-actions button{margin-left:6px}

        .activity-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-right: 4px solid var(--secondary);
        }
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .activity-user {
            font-weight: bold;
            color: var(--primary);
        }
        .activity-time {
            color: #666;
            font-size: 0.9rem;
        }
        .activity-action {
            color: #333;
            margin-bottom: 5px;
        }
        .activity-details {
            color: #666;
            font-size: 0.9rem;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .sync-status.error {
            background: var(--danger);
        }
        .sync-status.warning {
            background: var(--warning);
        }

        .signature-card {
            position: RANDOM;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .signature-card:hover { transform: scale(1.05); box-shadow: 0 12px 35px rgba(0,0,0,0.4); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }
        @keyframes borderGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .signature-card .name { font-size: 1.3rem; font-weight: 700; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .signature-card .title { font-size: 0.9rem; opacity: 0.9; font-weight: 500; }
        @media (max-width: 768px) { .signature-card { position: relative; bottom: auto; left: auto; margin: 20px auto 0; width: fit-content; animation: none; } .signature-card:hover { transform: none; } }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div id="loginBox">
            <h3>تسجيل الدخول</h3>
            <label>اسم المستخدم</label>
            <input id="loginUsername" placeholder="اسم المستخدم (حساسية الأحرف غير مفروضة)">
            <label>كلمة المرور</label>
            <input id="loginPassword" type="password" placeholder="كلمة المرور">
            <div style="display:flex;gap:8px;margin-top:10px;">
                <button id="loginSubmit" class="btn btn-primary">دخول</button>
                <button id="loginCancel" class="btn btn-warning">إلغاء</button>
            </div>
            <div id="loginError">اسم المستخدم أو كلمة المرور غير صحيحة</div>
        </div>
    </div>

    <div id="syncStatus" class="sync-status"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img id="logoImage" src="https://scontent.fkwi10-2.fna.fbcdn.net/v/t39.30808-1/274337806_4811171878951383_6292867314485568980_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=105&ccb=1-7&_nc_sid=2d3e12&_nc_ohc=gfSsyB-y4oEQ7kNvwFSOgbN&_nc_oc=AdnJP2KhOSzQE9cgCu1bxpM3HudIMgkQY6ZCvnn-e3Su12-i5FvOaV_l0YOuZTW-pw4&_nc_zt=24&_nc_ht=scontent.fkwi10-2.fna&_nc_gid=tCHABk-P_H4zvDiygcRwOg&oh=00_Afj4PzMWS7LdUQS3gRx9ndssLzfIX2KbScG-dYfRkwIlCA&oe=6924C92B" alt="شعار مطاعم نايف">
                    <i class="fas fa-utensils"></i>
                    <h1>نظام إدارة زيارات المطاعم لمطاعم نايف</h1>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span id="currentUser">Yasser Elkhateeb</span>
                    <button id="logoutBtn" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> لوحة التحكم
            </div>
            <div class="nav-tab" data-tab="visit">
                <i class="fas fa-clipboard-list"></i> تسجيل زيارة
            </div>
            <div class="nav-tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i> التقارير
            </div>
            <div class="nav-tab" data-tab="problems">
                <i class="fas fa-exclamation-triangle"></i> المتابعة
            </div>
            <div class="nav-tab" data-tab="history">
                <i class="fas fa-history"></i> الزيارات السابقة
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cogs"></i> الإعدادات
            </div>
        </div>

        <!-- لوحة التحكم -->
        <div class="tab-content active" id="dashboard">
            <h2>لوحة التحكم</h2>
            
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="dashboardOperations">مدير العمليات</label>
                        <select id="dashboardOperations">
                            <option value="all">جميع مدراء العمليات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dashboardManager">مدير المنطقة</label>
                        <select id="dashboardManager">
                            <option value="all">جميع المدراء</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dashboardRestaurant">المطعم</label>
                        <select id="dashboardRestaurant">
                            <option value="all">جميع المطاعم</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-danger" id="clearAllData" style="margin-right: 10px;">
                        <i class="fas fa-trash"></i> مسح جميع البيانات
                    </button>
                    <button class="btn btn-warning" id="backupData">
                        <i class="fas fa-download"></i> نسخة احتياطية
                    </button>
                    <button class="btn btn-success" id="restoreData">
                        <i class="fas fa-upload"></i> استرداد نسخة
                    </button>
                    <button class="btn btn-primary" id="syncWithGoogleSheets" style="display:none;">
                        <i class="fab fa-google"></i> مزامنة مع Google Sheets
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">عدد الزيارات هذا الشهر</div>
                    <div class="stat-value" id="monthlyVisitsCount">0</div>
                    <div class="stat-change" id="monthlyVisitsChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">متوسط المبيعات</div>
                    <div class="stat-value" id="avgSales">0</div>
                    <div class="stat-change" id="avgSalesChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">المشاكل النشطة</div>
                    <div class="stat-value" id="activeProblemsCount">0</div>
                    <div class="stat-change" id="activeProblemsChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">معدل رضا العملاء</div>
                    <div class="stat-value" id="customerSatisfaction">0</div>
                    <div class="stat-change" id="customerSatisfactionChange"></div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="card" style="flex: 2;">
                    <div class="card-header">
                        <div class="card-title">آخر الزيارات</div>
                    </div>
                    <div id="recentVisitsList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </div>
                </div>
                
                <div class="card" style="flex: 1;">
                    <div class="card-header">
                        <div class="card-title">المطاعم التابعة لي</div>
                    </div>
                    <ul id="myRestaurantsList" style="list-style: none; padding: 0;">
                        <!-- سيتم ملؤها بالبيانات -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- تسجيل زيارة -->
        <div class="tab-content" id="visit">
            <h2>تسجيل زيارة جديدة</h2>
            
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="visitAreaManager">مدير المنطقة</label>
                        <select id="visitAreaManager">
                            <option value="">-- اختر مدير المنطقة --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="restaurant">اختر المطعم</label>
                        <select id="restaurant" required>
                            <option value="">-- اختر المطعم --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="visitMonth">الشهر</label>
                        <select id="visitMonth" required>
                            <option value="">-- اختر الشهر --</option>
                            <option value="1">يناير</option>
                            <option value="2">فبراير</option>
                            <option value="3">مارس</option>
                            <option value="4">أبريل</option>
                            <option value="5">مايو</option>
                            <option value="6">يونيو</option>
                            <option value="7">يوليو</option>
                            <option value="8">أغسطس</option>
                            <option value="9">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="visitYear">السنة</label>
                        <select id="visitYear" required>
                            <option value="">-- اختر السنة --</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="visitWeek">الأسبوع</label>
                        <select id="visitWeek" required>
                            <option value="">-- اختر الأسبوع --</option>
                            <option value="1">الأسبوع الأول</option>
                            <option value="2">الأسبوع الثاني</option>
                            <option value="3">الأسبوع الثالث</option>
                            <option value="4">الأسبوع الرابع</option>
                            <option value="5">الأسبوع الخامس</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <form id="visitForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sales">متابعة المبيعات</label>
                            <input type="number" id="sales" placeholder="أدخل قيمة المبيعات" required>
                        </div>
                        <div class="form-group">
                            <label for="customers">متابعة عدد العملاء</label>
                            <input type="number" id="customers" placeholder="أدخل عدد العملاء" required>
                        </div>
                        <div class="form-group">
                            <label for="avgBill">متابعة متوسط الشيك</label>
                            <input type="number" step="0.001" id="avgBill" placeholder="أدخل متوسط الشيك" required>
                        </div>
                        <div class="form-group">
                            <label for="customerProblems">عدد مشاكل العملاء</label>
                            <input type="number" id="customerProblems" placeholder="أدخل عدد مشاكل العملاء">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itProblems">متابعة مشاكل IT</label>
                            <textarea id="itProblems" placeholder="وصف مشاكل IT إن وجدت" style="min-height: 45px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="plumbingProblems">متابعة مشاكل السباكة والصرف الصحي</label>
                            <textarea id="plumbingProblems" placeholder="وصف مشاكل السباكة والصرف الصحي" style="min-height: 45px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceHeater">متابعة مشاكل الصيانة (سخان - كهرباء) أمام</label>
                            <textarea id="maintenanceHeater" placeholder="وصف مشاكل الصيانة (سخان - كهرباء)" style="min-height: 45px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceAC">متابعة مشاكل الصيانة (تكييف- بارد) رفيق</label>
                            <textarea id="maintenanceAC" placeholder="وصف مشاكل الصيانة (تكييف- بارد)" style="min-height: 45px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="training">زيارات التدريب</label>
                            <textarea id="training" placeholder="تفاصيل زيارات التدريب" style="min-height: 45px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="quality">زيارات الجودة</label>
                            <textarea id="quality" placeholder="ملاحظات الجودة" style="min-height: 45px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="licenses">التراخيص</label>
                            <textarea id="licenses" placeholder="ملاحظات التراخيص" style="min-height: 45px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="operationalTools">احتياجات أدوات التشغيل</label>
                            <textarea id="operationalTools" placeholder="احتياجات أدوات التشغيل" style="min-height: 45px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="suggestions">اقتراحات</label>
                            <textarea id="suggestions" placeholder="أي اقتراحات" style="min-height: 45px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="other">أخرى</label>
                            <textarea id="other" placeholder="أي ملاحظات إضافية" style="min-height: 45px;"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> حفظ الزيارة
                    </button>
                </form>
            </div>
        </div>

        <!-- التقارير -->
        <div class="tab-content" id="reports">
            <h2>التقارير</h2>
            
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="reportOperations">مدير العمليات</label>
                        <select id="reportOperations">
                            <option value="all">جميع مدراء العمليات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportAreaManager">مدير المنطقة</label>
                        <select id="reportAreaManager">
                            <option value="all">جميع المدراء</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportRestaurant">المطعم</label>
                        <select id="reportRestaurant">
                            <option value="all">جميع المطاعم</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="reportMonth">الشهر</label>
                        <select id="reportMonth">
                            <option value="all">جميع الأشهر</option>
                            <option value="1">يناير</option>
                            <option value="2">فبراير</option>
                            <option value="3">مارس</option>
                            <option value="4">أبريل</option>
                            <option value="5">مايو</option>
                            <option value="6">يونيو</option>
                            <option value="7">يوليو</option>
                            <option value="8">أغسطس</option>
                            <option value="9">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportYear">السنة</label>
                        <select id="reportYear">
                            <option value="all">جميع السنوات</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportType">نوع التقرير</label>
                        <select id="reportType">
                            <option value="all">تقرير عام</option>
                            <option value="areaManager">تقرير مدير المنطقة</option>
                            <option value="operationsManager">تقرير مدير العمليات</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" id="exportPdf">
                        <i class="fas fa-file-pdf"></i> تصدير PDF
                    </button>
                    <button class="btn btn-warning" id="exportExcel">
                        <i class="fas fa-file-excel"></i> تصدير Excel
                    </button>
                    <button class="btn btn-success" id="sendWhatsApp">
                        <i class="fab fa-whatsapp"></i> إرسال عبر واتساب
                    </button>
                </div>
            </div>
            
            <div class="report-header">
                <div class="report-info">
                    <h3>تقرير زيارات المطاعم</h3>
                    <p id="reportDetails">جميع الزيارات</p>
                </div>
            </div>
            
            <div class="card">
                <div class="print-title" id="printTitle" style="display: none;"></div>
                <div class="report-table-container">
                    <table class="report-table" id="reportTable">
                        <thead>
                            <tr>
                                <th>المطعم</th>
                                <th>الشهر</th>
                                <th>الأسبوع</th>
                                <th>المبيعات</th>
                                <th>عدد العملاء</th>
                                <th>متوسط الشيك</th>
                                <th>مشاكل العملاء</th>
                                <th>مشاكل IT</th>
                                <th>مشاكل السباكة</th>
                                <th>صيانة (سخان-كهرباء)</th>
                                <th>صيانة (تكييف-بارد)</th>
                                <th>التدريب</th>
                                <th>الجودة</th>
                                <th>التراخيص</th>
                                <th>أدوات التشغيل</th>
                                <th>اقتراحات</th>
                                <th>أخرى</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- سيتم ملؤها بالبيانات -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- المتابعة -->
        <div class="tab-content" id="problems">
            <h2>متابعة المشاكل والحلول</h2>
            
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="problemOperations">مدير العمليات</label>
                        <select id="problemOperations">
                            <option value="all">جميع مدراء العمليات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="problemAreaManager">مدير المنطقة</label>
                        <select id="problemAreaManager">
                            <option value="all">جميع المدراء</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="problemRestaurant">المطعم</label>
                        <select id="problemRestaurant">
                            <option value="all">جميع المطاعم</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="problemType">نوع المشكلة</label>
                        <select id="problemType">
                            <option value="all">جميع المشاكل</option>
                            <option value="it">مشاكل IT</option>
                            <option value="plumbing">مشاكل السباكة</option>
                            <option value="maintenance_heater">مشاكل الصيانة (سخان-كهرباء)</option>
                            <option value="maintenance_ac">مشاكل الصيانة (تكييف-بارد)</option>
                            <option value="quality">مشاكل الجودة</option>
                            <option value="training">مشاكل التدريب</option>
                            <option value="licenses">مشاكل التراخيص</option>
                            <option value="tools">مشاكل أدوات التشغيل</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="problemStatus">حالة المشكلة</label>
                        <select id="problemStatus">
                            <option value="all">جميع الحالات</option>
                            <option value="active">نشطة</option>
                            <option value="resolved">تم الحل</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">المشاكل النشطة</div>
                </div>
                <div id="problemsList">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
        </div>

        <!-- الزيارات السابقة -->
        <div class="tab-content" id="history">
            <h2>الزيارات السابقة</h2>
            
            <div class="filters">
                <div class="filter-row">
                   <div class="filter-group">
                        <label for="historyManager">مدير المنطقة</label>
                        <select id="historyManager">
                            <option value="all">جميع المدراء</option>
                        </select>
                    </div>
			 <div class="filter-group">
                        <label for="historyRestaurant">المطعم</label>
                        <select id="historyRestaurant">
                            <option value="all">جميع المطاعم</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="historyMonth">الشهر</label>
                        <select id="historyMonth">
                            <option value="all">جميع الأشهر</option>
                            <option value="1">يناير</option>
                            <option value="2">فبراير</option>
                            <option value="3">مارس</option>
                            <option value="4">أبريل</option>
                            <option value="5">مايو</option>
                            <option value="6">يونيو</option>
                            <option value="7">يوليو</option>
                            <option value="8">أغسطس</option>
                            <option value="9">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="historyYear">السنة</label>
                        <select id="historyYear">
                            <option value="all">جميع السنوات</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    </div>
            </div>
            
            <div id="visitsHistoryList">
                <!-- سيتم ملؤها بالبيانات -->
            </div>
        </div>

        <!-- شاشة الإعدادات -->
        <div class="tab-content" id="settings">
            <h2><i class="fas fa-cogs"></i> الإعدادات والإدارة</h2>
            
            <!-- إدارة البيانات والمزامنة -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إدارة البيانات والمزامنة</div>
                    </div>
                    <div class="settings-actions" style="margin-bottom:15px; display: flex; flex-wrap: wrap; gap: 10px;">
    <button class="btn btn-danger" id="settingsClearAllData">
        <i class="fas fa-trash"></i> مسح جميع البيانات
    </button>
    <button class="btn btn-warning" id="settingsBackupData">
        <i class="fas fa-download"></i> نسخة احتياطية
    </button>
    <button class="btn btn-success" id="settingsRestoreData">
        <i class="fas fa-upload"></i> استرداد نسخة
    </button>
    <button class="btn btn-primary" id="settingsSyncWithGoogleSheets">
        <i class="fab fa-google"></i> مزامنة مع Google Sheets
    </button>
</div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">
                            <i class="fas fa-sync-alt"></i> المزامنة التلقائية
                        </h4>
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <label style="margin: 0;">
                                <input type="checkbox" id="autoSyncToggle"> تفعيل المزامنة التلقائية كل 5 دقائق
                            </label>
                            <span id="autoSyncStatus" style="color: #666; font-size: 0.9rem;">
                                (غير مفعل)
                            </span>
                            <button class="btn btn-sm btn-info" id="testAutoSync" style="padding: 5px 10px;">
                                <i class="fas fa-play"></i> اختبار الآن
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إعدادات Google Sheets -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fab fa-google"></i> إعدادات Google Sheets
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="googleScriptUrlDisplay">رابط Google Apps Script:</label>
                        <input type="text" id="googleScriptUrlDisplay" 
                               readonly
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="setupGoogleScript">
                            <i class="fas fa-edit"></i> تعيين/تغيير الرابط
                        </button>
                        <button class="btn btn-success" id="testGoogleConnection">
                            <i class="fas fa-wifi"></i> اختبار الاتصال
                        </button>
                        <button class="btn btn-warning" id="clearGoogleUrl">
                            <i class="fas fa-trash"></i> مسح الرابط
                        </button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #E6F7FF; border-radius: 5px; border-right: 4px solid #4AB9DC;">
                        <h4 style="margin: 0 0 10px 0; color: #2A6B8F;">تعليمات الإعداد:</h4>
                        <ol style="margin: 0; padding-right: 20px; color: #666; font-size: 0.9rem;">
                            <li>أنشئ مشروع Google Apps Script جديد</li>
                            <li>الصق كود معالجة البيانات</li>
                            <li>انشر كـ "تطبيق ويب"</li>
                            <li>عيّن الصلاحيات لـ "أي شخص"</li>
                            <li>انسخ رابط النشر وأدخله هنا</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- إدارة المستخدمين -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إدارة المستخدمين</div>
                    </div>
                    <div class="settings-actions" style="margin-bottom:15px;">
                        <button class="btn btn-success" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> إضافة مستخدم جديد
                        </button>
                    </div>
                    <div id="usersList">
                        <!-- سيتم ملؤها بقائمة المستخدمين -->
                    </div>
                </div>
            </div>

            <!-- سجل النشاطات -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">سجل النشاطات</div>
                    </div>
                    <div class="settings-actions" style="margin-bottom:15px;">
                        <button class="btn btn-success" id="exportActivities">
                            <i class="fas fa-file-excel"></i> تصدير سجل النشاطات
                        </button>
                        <button class="btn btn-danger" id="clearActivities">
                            <i class="fas fa-trash"></i> مسح سجل النشاطات
                        </button>
                    </div>
                    <div id="activitiesList">
                        <!-- سيتم ملؤها بسجل النشاطات -->
                    </div>
                </div>
            </div>

            <!-- إعدادات الشعار -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إعدادات الشعار</div>
                    </div>
                    <div class="form-group">
                        <label for="logoUrl">رابط الشعار</label>
                        <input type="text" id="logoUrl" placeholder="أدخل رابط الشعار">
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" id="saveLogo">
                            <i class="fas fa-save"></i> حفظ الشعار
                        </button>
                    </div>
                </div>
            </div>

            <!-- إدارة مديري العمليات -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إدارة مديري العمليات</div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-success" id="addOperationsManager">
                            <i class="fas fa-plus"></i> إضافة مدير عمليات جديد
                        </button>
                    </div>
                    <div id="operationsManagersList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </div>
                </div>
            </div>

            <!-- إدارة مديري المناطق -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إدارة مديري المناطق</div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-success" id="addAreaManager">
                            <i class="fas fa-plus"></i> إضافة مدير منطقة جديد
                        </button>
                    </div>
                    <div id="areaManagersList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </div>
                </div>
            </div>

            <!-- إدارة المطاعم -->
            <div class="settings-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">إدارة المطاعم</div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-success" id="addRestaurant">
                            <i class="fas fa-plus"></i> إضافة مطعم جديد
                        </button>
                    </div>
                    <div id="restaurantsManagementList">
                        <!-- سيتم ملؤها بالبيانات -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إرسال واتساب -->
    <div class="modal" id="whatsappModal">
        <div class="modal-content whatsapp-modal">
            <div class="modal-header">
                <h3 class="modal-title">إرسال التقرير عبر واتساب</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="phoneNumber">رقم الهاتف</label>
                <input type="tel" id="phoneNumber" placeholder="أدخل رقم الهاتف" value="+965">
            </div>
            <div class="form-group">
                <label for="whatsappMessage">رسالة إضافية (اختياري)</label>
                <textarea id="whatsappMessage" placeholder="أضف رسالة إضافية إذا رغبت"></textarea>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmSendWhatsApp">
                    <i class="fab fa-whatsapp"></i> إرسال
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نماذج الإضافة -->
    <div class="modal" id="addOperationsManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مدير عمليات جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newOperationsManagerName">اسم مدير العمليات</label>
                <input type="text" id="newOperationsManagerName" placeholder="أدخل اسم مدير العمليات">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmAddOperationsManager">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addAreaManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مدير منطقة جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newAreaManagerName">اسم مدير المنطقة</label>
                <input type="text" id="newAreaManagerName" placeholder="أدخل اسم مدير المنطقة">
            </div>
            <div class="form-group">
                <label for="newAreaManagerOperations">مدير العمليات التابع له</label>
                <select id="newAreaManagerOperations">
                    <option value="">-- اختر مدير العمليات --</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmAddAreaManager">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addRestaurantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إضافة مطعم جديد</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newRestaurantName">اسم المطعم</label>
                <input type="text" id="newRestaurantName" placeholder="أدخل اسم المطعم">
            </div>
            <div class="form-group">
                <label for="newRestaurantAreaManager">مدير المنطقة</label>
                <select id="newRestaurantAreaManager">
                    <option value="">-- اختر مدير المنطقة --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newRestaurantOperationsManager">مدير العمليات</label>
                <select id="newRestaurantOperationsManager">
                    <option value="">-- اختر مدير العمليات --</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmAddRestaurant">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج نقل المطعم -->
    <div class="modal" id="transferRestaurantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">نقل المطعم</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="transferRestaurantName">المطعم</label>
                <input type="text" id="transferRestaurantName" readonly>
            </div>
            <div class="form-group">
                <label for="transferToAreaManager">نقل إلى مدير منطقة</label>
                <select id="transferToAreaManager">
                    <option value="">-- اختر مدير المنطقة --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="transferToOperationsManager">نقل إلى مدير عمليات</label>
                <select id="transferToOperationsManager">
                    <option value="">-- اختر مدير العمليات --</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-warning" id="confirmTransferRestaurant">
                    <i class="fas fa-exchange-alt"></i> نقل
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج تعديل الزيارة -->
    <div class="modal" id="editVisitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تعديل الزيارة</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="editVisitFormContainer">
                <!-- سيتم ملؤها بالبيانات -->
            </div>
        </div>
    </div>

    <!-- نموذج نقل مدير المنطقة -->
    <div class="modal" id="transferAreaManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">نقل مدير المنطقة</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="transferAreaManagerName">مدير المنطقة</label>
                <input type="text" id="transferAreaManagerName" readonly>
            </div>
            <div class="form-group">
                <label for="transferAreaManagerToOperations">نقل إلى مدير عمليات</label>
                <select id="transferAreaManagerToOperations">
                    <option value="">-- اختر مدير العمليات --</option>
                </select>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-warning" id="confirmTransferAreaManager">
                    <i class="fas fa-exchange-alt"></i> نقل
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج استيراد البيانات -->
    <div class="modal" id="importDataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">استيراد البيانات</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="importFile">اختر ملف النسخة الاحتياطية</label>
                <input type="file" id="importFile" accept=".json">
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmImportData">
                    <i class="fas fa-upload"></i> استيراد
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نموذج إعدادات Google Script -->
    <div class="modal" id="googleScriptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">إعدادات Google Apps Script</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="googleScriptUrlInput">رابط Google Apps Script:</label>
                <input type="text" id="googleScriptUrlInput" 
                       placeholder="https://script.google.com/macros/s/AKfycbx9q59JWlm-dPdGunq2nDHuMFj80QD3-9CwqmE5ViSaw8WlYWsgWmouucfIiIoaj9Y/exec" 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #E6F7FF; border-radius: 5px;">
                <h4 style="margin: 0 0 10px 0; color: #2A6B8F;">كيفية الحصول على الرابط:</h4>
                <ol style="margin: 0; padding-right: 20px; color: #666; font-size: 0.9rem;">
                    <li>اذهب إلى <a href="https://script.google.com" target="_blank">script.google.com</a></li>
                    <li>أنشئ مشروع جديد</li>
                    <li>الصق كود معالجة البيانات</li>
                    <li>انشر → إدارة النشر → إنشاء نشر جديد</li>
                    <li>اختر "تطبيق ويب" وعيّن الصلاحيات لـ "أي شخص"</li>
                    <li>انسخ رابط النشر وأدخله هنا</li>
                </ol>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" id="confirmGoogleScriptUrl">
                    <i class="fas fa-save"></i> حفظ الرابط
                </button>
                <button class="btn btn-primary close-modal">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- توقيع المطور -->
    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 67011143</div>
    </div>

    <footer>
        <div class="container">
            <p>نظام إدارة زيارات المطاعم لمطاعم نايف - تم التطوير خصيصًا لمتطلبات إدارة المطاعم بدولة الكويت</p>
            <p>© 2025 جميع الحقوق محفوظة</p>
        </div>
    </footer>

    <script>
        // ===== إعدادات Google Apps Script =====
        // تم تعيين الرابط مسبقاً في الملف كما طلبت
        let GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyNMV6_S99DLd99n19OXNa492PBpd4KVRm5AHlXzG1_k_Rn2KYr6jRGzQrXTduaF3k/exec';
        
        // ===== بيانات التطبيق =====
        let restaurantsData = [
            { name: "Faiha", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "Bahrain.St", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "Adan & Qusor Coop", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Jabriya.Teka.Fried", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "Fahaheel", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Abu Halifa", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Regai", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "Meshrif", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "Nafoura", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "AlQadsia", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "Sabah AlSalem", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Dabaiya", areaManager: "waleed", operationsManager: "Hany" },
            { name: "AlSharq", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Jabriya B.D", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "AlJahra Zoweikh", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "AlShuwaikh Warah", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "AlSayed Yaseen", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "AlFintas", areaManager: "waleed", operationsManager: "Hany" },
            { name: "AlSindbad", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "AlMatar", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "AlMunqaf", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Hawally Park", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "AlRiqqa", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "AlRehab", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "Hadiya", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "AlSulaibikhat Club", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "AlJahra Industrial", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "Farwaniya1", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "Aswaq AlQurain", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Salwa", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Jleeb souq", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "Shuhada", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Dasma & Bnaid AlQar", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Sabah AlAhmad", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Avenues", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "AlSulaibiya Industrial", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "Abu Fatira", areaManager: "waleed", operationsManager: "Hany" },
            { name: "West Abu Fatira", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Khaitan AlOsaimi", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Wafra", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Qairwan", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "Ahmadi", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Farwaniya2", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "Sulaibiya.Coop", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "Zahra", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "Jaber AlAhmad City", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "Khiran Outlet Mall", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Khiran Oia", areaManager: "waleed", operationsManager: "Hany" },
            { name: "Jahra Layali AlSharq", areaManager: "M.Hegazy", operationsManager: "Tarek.B" },
            { name: "Jahra Makkah Complex", areaManager: "Tarek.H", operationsManager: "Tarek.B" },
            { name: "New Ardiya", areaManager: "Emad", operationsManager: "Tarek.B" },
            { name: "AlRai", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "Marina Mall", areaManager: "Mokhtar", operationsManager: "Hany" },
            { name: "Sabah AlSalem AlAreen", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "Mall 360", areaManager: "M.Anwar", operationsManager: "Tarek.B" },
            { name: "AlKhuyoul", areaManager: "Tharwat", operationsManager: "Hany" },
            { name: "AlKout Complex", areaManager: "waleed", operationsManager: "Hany" }
        ];

        let areaManagers = [...new Set(restaurantsData.map(r => r.areaManager))];
        let operationsManagers = [...new Set(restaurantsData.map(r => r.operationsManager))];

        // بيانات الزيارات - إضافة بيانات تجريبية
        let visitsData = [];

        // بيانات المشاكل - إضافة بيانات تجريبية
        let problemsData = [];

        // Users data (يمكن تعديلها أو إدارتها من الإعدادات)
        let usersData = [
            {id:1, name: "test", password: "123", role: "admin"},
            {id:2, name: "Yasser", password: "123", role: "superadmin"},
            {id:3, name: "M.Hegazy", password: "123", role: "areaManager", areaManager: "M.Hegazy"},
            {id:4, name: "Hany", password: "123", role: "operationsManager"},
            {id:5, name: "Tarek.B", password: "123", role: "operationsManager"},
            {id:6, name: "Mokhtar", password: "123", role: "areaManager", areaManager: "Mokhtar"},
            {id:7, name: "M.Anwar", password: "123", role: "areaManager", areaManager: "M.Anwar"},
            {id:8, name: "waleed", password: "123", role: "areaManager", areaManager: "waleed"},
            {id:9, name: "Tharwat", password: "123", role: "areaManager", areaManager: "Tharwat"},
            {id:10, name: "Emad", password: "123", role: "areaManager", areaManager: "Emad"},
            {id:11, name: "Tarek.H", password: "123", role: "areaManager", areaManager: "Tarek.H"},
            {id:12, name: "Faiha", password: "123", role: "restaurant", restaurant: "Faiha"},
            {id:13, name: "Bahrain.St", password: "123", role: "restaurant", restaurant: "Bahrain.St"},
            {id:14, name: "Adan & Qusor Coop", password: "123", role: "restaurant", restaurant: "Adan & Qusor Coop"},
            {id:15, name: "Jabriya.Teka.Fried", password: "123", role: "restaurant", restaurant: "Jabriya.Teka.Fried"},
            {id:16, name: "Fahaheel", password: "123", role: "restaurant", restaurant: "Fahaheel"},
            {id:17, name: "Abu Halifa", password: "123", role: "restaurant", restaurant: "Abu Halifa"},
            {id:18, name: "Regai", password: "123", role: "restaurant", restaurant: "Regai"},
            {id:19, name: "Meshrif", password: "123", role: "restaurant", restaurant: "Meshrif"},
            {id:20, name: "Nafoura", password: "123", role: "restaurant", restaurant: "Nafoura"},
            {id:21, name: "AlQadsia", password: "123", role: "restaurant", restaurant: "AlQadsia"},
            {id:22, name: "Sabah AlSalem", password: "123", role: "restaurant", restaurant: "Sabah AlSalem"},
            {id:23, name: "Dabaiya", password: "123", role: "restaurant", restaurant: "Dabaiya"},
            {id:24, name: "AlSharq", password: "123", role: "restaurant", restaurant: "AlSharq"},
            {id:25, name: "Jabriya B.D", password: "123", role: "restaurant", restaurant: "Jabriya B.D"},
            {id:26, name: "AlJahra Zoweikh", password: "123", role: "restaurant", restaurant: "AlJahra Zoweikh"},
            {id:27, name: "AlShuwaikh Warah", password: "123", role: "restaurant", restaurant: "AlShuwaikh Warah"},
            {id:28, name: "AlSayed Yaseen", password: "123", role: "restaurant", restaurant: "AlSayed Yaseen"},
            {id:29, name: "AlFintas", password: "123", role: "restaurant", restaurant: "AlFintas"},
            {id:30, name: "AlSindbad", password: "123", role: "restaurant", restaurant: "AlSindbad"},
            {id:31, name: "AlMatar", password: "123", role: "restaurant", restaurant: "AlMatar"},
            {id:32, name: "AlMunqaf", password: "123", role: "restaurant", restaurant: "AlMunqaf"},
            {id:33, name: "Hawally Park", password: "123", role: "restaurant", restaurant: "Hawally Park"},
            {id:34, name: "AlRiqqa", password: "123", role: "restaurant", restaurant: "AlRiqqa"},
            {id:35, name: "AlRehab", password: "123", role: "restaurant", restaurant: "AlRehab"},
            {id:36, name: "Hadiya", password: "123", role: "restaurant", restaurant: "Hadiya"},
            {id:37, name: "AlSulaibikhat Club", password: "123", role: "restaurant", restaurant: "AlSulaibikhat Club"},
            {id:38, name: "AlJahra Industrial", password: "123", role: "restaurant", restaurant: "AlJahra Industrial"},
            {id:39, name: "Farwaniya1", password: "123", role: "restaurant", restaurant: "Farwaniya1"},
            {id:40, name: "Aswaq AlQurain", password: "123", role: "restaurant", restaurant: "Aswaq AlQurain"},
            {id:41, name: "Salwa", password: "123", role: "restaurant", restaurant: "Salwa"},
            {id:42, name: "Jleeb souq", password: "123", role: "restaurant", restaurant: "Jleeb souq"},
            {id:43, name: "Shuhada", password: "123", role: "restaurant", restaurant: "Shuhada"},
            {id:44, name: "Dasma & Bnaid AlQar", password: "123", role: "restaurant", restaurant: "Dasma & Bnaid AlQar"},
            {id:45, name: "Sabah AlAhmad", password: "123", role: "restaurant", restaurant: "Sabah AlAhmad"},
            {id:46, name: "Avenues", password: "123", role: "restaurant", restaurant: "Avenues"},
            {id:47, name: "AlSulaibiya Industrial", password: "123", role: "restaurant", restaurant: "AlSulaibiya Industrial"},
            {id:48, name: "Abu Fatira", password: "123", role: "restaurant", restaurant: "Abu Fatira"},
            {id:49, name: "West Abu Fatira", password: "123", role: "restaurant", restaurant: "West Abu Fatira"},
            {id:50, name: "Khaitan AlOsaimi", password: "123", role: "restaurant", restaurant: "Khaitan AlOsaimi"},
            {id:51, name: "Wafra", password: "123", role: "restaurant", restaurant: "Wafra"},
            {id:52, name: "Qairwan", password: "123", role: "restaurant", restaurant: "Qairwan"},
            {id:53, name: "Ahmadi", password: "123", role: "restaurant", restaurant: "Ahmadi"},
            {id:54, name: "Farwaniya2", password: "123", role: "restaurant", restaurant: "Farwaniya2"},
            {id:55, name: "Sulaibiya.Coop", password: "123", role: "restaurant", restaurant: "Sulaibiya.Coop"},
            {id:56, name: "Zahra", password: "123", role: "restaurant", restaurant: "Zahra"},
            {id:57, name: "Jaber AlAhmad City", password: "123", role: "restaurant", restaurant: "Jaber AlAhmad City"},
            {id:58, name: "Khiran Outlet Mall", password: "123", role: "restaurant", restaurant: "Khiran Outlet Mall"},
            {id:59, name: "Khiran Oia", password: "123", role: "restaurant", restaurant: "Khiran Oia"},
            {id:60, name: "Jahra Layali AlSharq", password: "123", role: "restaurant", restaurant: "Jahra Layali AlSharq"},
            {id:61, name: "Jahra Makkah Complex", password: "123", role: "restaurant", restaurant: "Jahra Makkah Complex"},
            {id:62, name: "New Ardiya", password: "123", role: "restaurant", restaurant: "New Ardiya"},
            {id:63, name: "AlRai", password: "123", role: "restaurant", restaurant: "AlRai"},
            {id:64, name: "Marina Mall", password: "123", role: "restaurant", restaurant: "Marina Mall"},
            {id:65, name: "Sabah AlSalem AlAreen", password: "123", role: "restaurant", restaurant: "Sabah AlSalem AlAreen"},
            {id:66, name: "Mall 360", password: "123", role: "restaurant", restaurant: "Mall 360"},
            {id:67, name: "AlKhuyoul", password: "123", role: "restaurant", restaurant: "AlKhuyoul"},
            {id:68, name: "AlKout Complex", password: "123", role: "restaurant", restaurant: "AlKout Complex"}
        ];

        // بيانات سجل النشاطات
        let userActivities = [];

        // ===== إعدادات المزامنة =====
        let autoSyncInterval = null;
        let isAutoSyncEnabled = false;
        let currentUser = null;
        let isOnline = true;
        let pendingSyncOperations = [];

        // متغيرات للإعدادات
        let currentTransferRestaurant = null;
        let currentEditVisitId = null;
        let currentTransferAreaManager = null;

        // ===== دوال التخزين المحلي =====
        function saveUsers() {
            localStorage.setItem('users_data', JSON.stringify(usersData));
        }
        
        function loadUsers() {
            const s = localStorage.getItem('users_data');
            if (s) {
                try { usersData = JSON.parse(s); } catch(e){}
            }
        }

        function saveActivities() {
            localStorage.setItem('user_activities', JSON.stringify(userActivities));
        }
        
        function loadActivities() {
            const s = localStorage.getItem('user_activities');
            if (s) {
                try { userActivities = JSON.parse(s); } catch(e){}
            }
        }

        function saveAllData() {
            const data = {
                restaurantsData,
                visitsData,
                problemsData,
                areaManagers,
                operationsManagers,
                usersData,
                userActivities,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('app_data', JSON.stringify(data));
        }
        
        function loadAllData() {
            const s = localStorage.getItem('app_data');
            if (s) {
                try { 
                    const data = JSON.parse(s);
                    if (data.restaurantsData) restaurantsData = data.restaurantsData;
                    if (data.visitsData) visitsData = data.visitsData;
                    if (data.problemsData) problemsData = data.problemsData;
                    if (data.areaManagers) areaManagers = data.areaManagers;
                    if (data.operationsManagers) operationsManagers = data.operationsManagers;
                    if (data.usersData) usersData = data.usersData;
                    if (data.userActivities) userActivities = data.userActivities;
                } catch(e){}
            }
        }

        function loadGoogleScriptUrl() {
            // استخدام الرابط المدمج في الملف
            document.getElementById('googleScriptUrlDisplay').value = GOOGLE_SCRIPT_URL;
        }

        function loadAutoSyncSetting() {
            const autoSync = localStorage.getItem('auto_sync_enabled');
            if (autoSync === 'true') {
                isAutoSyncEnabled = true;
                document.getElementById('autoSyncToggle').checked = true;
                startAutoSync();
                updateAutoSyncStatus('مفعل - يعمل كل 5 دقائق');
            } else {
                updateAutoSyncStatus('غير مفعل');
            }
        }

        // ===== نظام المزامنة التلقائية =====
        function startAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            autoSyncInterval = setInterval(autoSyncWithGoogleSheets, 5 * 60 * 1000); // كل 5 دقائق
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
        }

        async function autoSyncWithGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL || !isAutoSyncEnabled || !isOnline) return;
            
            try {
                showSyncNotification('🔄 جاري المزامنة التلقائية...', 'warning');
                
                const dataToSync = {
                    action: 'autoSync',
                    visitsData: visitsData,
                    restaurantsData: restaurantsData,
                    problemsData: problemsData,
                    usersData: usersData,
                    userActivities: userActivities,
                    timestamp: new Date().toISOString(),
                    syncUser: currentUser ? currentUser.name : 'نظام تلقائي',
                    version: '2.0',
                    autoSync: true
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dataToSync)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showSyncNotification('✅ تمت المزامنة التلقائية بنجاح', 'success');
                        logActivity('مزامنة تلقائية ناجحة', 
                            `تم مزامنة ${visitsData.length} زيارة تلقائياً`);
                    }
                }
            } catch (error) {
                console.log('❌ خطأ في المزامنة التلقائية:', error);
                showSyncNotification('❌ فشلت المزامنة التلقائية', 'error');
            }
        }

        // ===== المزامنة الفورية بعد كل عملية =====
        async function syncAfterOperation(operationType, data) {
            if (!GOOGLE_SCRIPT_URL || !isOnline) {
                // إذا لم يكن هناك اتصال، احفظ العملية للتنفيذ لاحقاً
                pendingSyncOperations.push({type: operationType, data: data, timestamp: new Date().toISOString()});
                saveAllData();
                return;
            }
            
            try {
                const syncData = {
                    action: 'syncOperation',
                    operationType: operationType,
                    data: data,
                    visitsData: visitsData,
                    restaurantsData: restaurantsData,
                    problemsData: problemsData,
                    usersData: usersData,
                    userActivities: userActivities,
                    timestamp: new Date().toISOString(),
                    syncUser: currentUser ? currentUser.name : 'غير معروف'
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(syncData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`✅ تمت مزامنة عملية ${operationType} بنجاح`);
                    }
                }
            } catch (error) {
                console.log(`❌ خطأ في مزامنة عملية ${operationType}:`, error);
                // في حالة الخطأ، احفظ العملية للتنفيذ لاحقاً
                pendingSyncOperations.push({type: operationType, data: data, timestamp: new Date().toISOString()});
                saveAllData();
            }
        }

        // ===== استرداد البيانات من Google Sheets عند فتح التطبيق =====
        async function loadDataFromGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL || !isOnline) {
                loadAllData(); // تحميل البيانات المحلية إذا لم يكن هناك اتصال
                return;
            }
            
            try {
                showSyncNotification('🔄 جاري تحميل البيانات من السحابة...', 'warning');
                
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData&timestamp=${Date.now()}`);
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        // تحديث البيانات المحلية ببيانات السحابة
                        if (result.data.restaurantsData) restaurantsData = result.data.restaurantsData;
                        if (result.data.visitsData) visitsData = result.data.visitsData;
                        if (result.data.problemsData) problemsData = result.data.problemsData;
                        if (result.data.usersData) usersData = result.data.usersData;
                        if (result.data.userActivities) userActivities = result.data.userActivities;
                        
                        // استخراج مدراء المناطق والعمليات من بيانات المطاعم
                        areaManagers = [...new Set(restaurantsData.map(r => r.areaManager))];
                        operationsManagers = [...new Set(restaurantsData.map(r => r.operationsManager))];
                        
                        // حفظ البيانات محلياً
                        saveAllData();
                        
                        // تحديث الواجهة
                        updateAllUI();
                        
                        showSyncNotification('✅ تم تحميل البيانات من السحابة بنجاح', 'success');
                        logActivity('تحميل البيانات من السحابة', 'تم تحميل أحدث البيانات من Google Sheets');
                    }
                }
            } catch (error) {
                console.log('❌ خطأ في تحميل البيانات من السحابة:', error);
                loadAllData(); // استخدام البيانات المحلية في حالة الخطأ
                showSyncNotification('⚠️ استخدام البيانات المحلية', 'warning');
            }
        }

        // ===== معالجة العمليات المعلقة عند استعادة الاتصال =====
        async function processPendingSyncOperations() {
            if (pendingSyncOperations.length === 0 || !isOnline) return;
            
            try {
                showSyncNotification('🔄 جاري معالجة العمليات المعلقة...', 'warning');
                
                for (const operation of pendingSyncOperations) {
                    await syncAfterOperation(operation.type, operation.data);
                }
                
                // مسح العمليات المعلقة بعد معالجتها
                pendingSyncOperations = [];
                saveAllData();
                
                showSyncNotification('✅ تمت معالجة جميع العمليات المعلقة', 'success');
            } catch (error) {
                console.log('❌ خطأ في معالجة العمليات المعلقة:', error);
            }
        }

        // ===== مراقبة حالة الاتصال =====
        function setupConnectionMonitoring() {
            window.addEventListener('online', () => {
                isOnline = true;
                showSyncNotification('✅ تم استعادة الاتصال بالإنترنت', 'success');
                // معالجة العمليات المعلقة عند استعادة الاتصال
                processPendingSyncOperations();
                // تحميل أحدث البيانات من السحابة
                loadDataFromGoogleSheets();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showSyncNotification('⚠️ فقدان الاتصال بالإنترنت - استخدام البيانات المحلية', 'warning');
            });
            
            // التحقق الأولي من حالة الاتصال
            isOnline = navigator.onLine;
        }

        // ===== تحديث جميع عناصر الواجهة =====
        function updateAllUI() {
            loadDashboardStats();
            loadRecentVisits();
            loadMyRestaurants();
            loadReportData();
            loadProblems();
            loadVisitsHistory();
            loadSettingsData();
            populateRestaurantSelects();
            populateManagerSelects();
            populateVisitAreaManagerSelect();
        }

        // ===== دوال مساعدة =====
        function getElementSafe(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }

        function showSyncNotification(message, type = 'success') {
            const syncStatus = document.getElementById('syncStatus');
            syncStatus.textContent = message;
            syncStatus.className = `sync-status ${type}`;
            syncStatus.style.display = 'block';
            
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 5000);
        }

        function updateAutoSyncStatus(status) {
            document.getElementById('autoSyncStatus').textContent = `(${status})`;
        }

        // ===== دوال Google Sheets =====
        function showGoogleScriptSetup() {
            document.getElementById('googleScriptModal').style.display = 'flex';
            document.getElementById('googleScriptUrlInput').value = GOOGLE_SCRIPT_URL;
        }

        function confirmGoogleScriptUrl() {
            const url = document.getElementById('googleScriptUrlInput').value.trim();
            if (url && url.includes('google.com')) {
                GOOGLE_SCRIPT_URL = url;
                localStorage.setItem('google_script_url', url);
                document.getElementById('googleScriptUrlDisplay').value = url;
                document.getElementById('googleScriptModal').style.display = 'none';
                showSyncNotification('✅ تم حفظ رابط Google Script بنجاح', 'success');
                logActivity('تعيين رابط Google Script', 'تم حفظ رابط المزامنة الجديد');
            } else {
                alert('⚠️ يرجى إدخال رابط Google Script صحيح');
            }
        }

        async function testGoogleConnection() {
            if (!GOOGLE_SCRIPT_URL) {
                alert('❌ لم يتم تعيين رابط Google Script');
                showGoogleScriptSetup();
                return;
            }

            const testBtn = document.getElementById('testGoogleConnection');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاختبار...';
            testBtn.disabled = true;

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=test&timestamp=${Date.now()}`);
                if (response.ok) {
                    showSyncNotification('✅ الاتصال مع Google Sheets نشط', 'success');
                } else {
                    throw new Error('فشل في الاتصال');
                }
            } catch (error) {
                showSyncNotification('❌ فشل اختبار الاتصال', 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        function clearGoogleUrl() {
            if (confirm('هل تريد مسح رابط Google Script الحالي؟')) {
                GOOGLE_SCRIPT_URL = '';
                localStorage.removeItem('google_script_url');
                document.getElementById('googleScriptUrlDisplay').value = '';
                showSyncNotification('تم مسح الرابط', 'warning');
            }
        }

        // ===== نظام تسجيل النشاطات =====
        function logActivity(action, details = '') {
            if (!currentUser) return;
            
            const activity = {
                id: userActivities.length > 0 ? Math.max(...userActivities.map(a => a.id)) + 1 : 1,
                userId: currentUser.id,
                userName: currentUser.name,
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG')
            };
            
            userActivities.push(activity);
            saveActivities();
            
            // تحديث عرض النشاطات إذا كان قسم النشاطات مفتوحًا
            if (document.getElementById('settings').classList.contains('active')) {
                loadActivitiesList();
            }
        }

        function loadActivitiesList() {
            const container = document.getElementById('activitiesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // عرض آخر 50 نشاط فقط
            const recentActivities = userActivities.slice(-50).reverse();
            
            if (recentActivities.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد نشاطات مسجلة</p>';
                return;
            }
            
            recentActivities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'activity-item';
                
                activityElement.innerHTML = `
                    <div class="activity-header">
                        <div class="activity-user">${activity.userName}</div>
                        <div class="activity-time">${activity.date} - ${activity.time}</div>
                    </div>
                    <div class="activity-action">${activity.action}</div>
                    ${activity.details ? `<div class="activity-details">${activity.details}</div>` : ''}
                `;
                
                container.appendChild(activityElement);
            });
        }

        function exportActivitiesToExcel() {
            if (userActivities.length === 0) {
                alert('لا توجد نشاطات لتصديرها');
                return;
            }
            
            // إنشاء مصنف جديد
            const wb = XLSX.utils.book_new();
            
            // تحضير البيانات
            const data = [
                ['سجل نشاطات المستخدمين - نظام إدارة زيارات المطاعم'],
                [''],
                ['تم الإنشاء في:', new Date().toLocaleDateString('ar-EG')],
                [''],
                ['المستخدم', 'النشاط', 'التفاصيل', 'التاريخ', 'الوقت']
            ];
            
            // إضافة النشاطات
            userActivities.forEach(activity => {
                data.push([
                    activity.userName,
                    activity.action,
                    activity.details,
                    activity.date,
                    activity.time
                ]);
            });
            
            // إنشاء ورقة عمل
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تنسيق الأعمدة
            const colWidths = [
                { wch: 20 }, // المستخدم
                { wch: 40 }, // النشاط
                { wch: 60 }, // التفاصيل
                { wch: 15 }, // التاريخ
                { wch: 15 }  // الوقت
            ];
            ws['!cols'] = colWidths;
            
            // دمج الخلايا للعنوان
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            
            // إضافة الورقة إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'سجل النشاطات');
            
            // حفظ الملف
            XLSX.writeFile(wb, 'سجل_نشاطات_المستخدمين.xlsx');
            
            logActivity('تصدير سجل النشاطات', 'تم تصدير سجل النشاطات إلى ملف Excel');
        }

        function clearActivities() {
            if (confirm('هل أنت متأكد من مسح سجل النشاطات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                userActivities = [];
                saveActivities();
                loadActivitiesList();
                alert('تم مسح سجل النشاطات بنجاح');
                logActivity('مسح سجل النشاطات', 'تم مسح جميع سجلات النشاطات');
            }
        }

        // ===== نظام تسجيل الدخول =====
        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
            // hide logout button until logged-in
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.style.display = 'none';
        }
        function hideLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'none';
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.style.display = 'block';
        }

        // Case-insensitive login for username
        function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { 
                showLoginError('ادخل اسم المستخدم وكلمة المرور');
                return;
            }
            const user = usersData.find(u => u.name.toLowerCase() === username.toLowerCase() && u.password === password);
            if (user) {
                currentUser = user;
                document.getElementById('loginError').style.display = 'none';
                hideLoginOverlay();
                applyPermissionsForCurrentUser();
                logActivity('تسجيل الدخول', `تم تسجيل دخول المستخدم ${user.name}`);
            } else {
                showLoginError('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }
        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        // Logout - returns to login overlay and clears currentUser
        function doLogout() {
            if (currentUser) {
                logActivity('تسجيل الخروج', `تم تسجيل خروج المستخدم ${currentUser.name}`);
            }
            currentUser = null;
            showLoginOverlay();
        }

        // ===== تطبيق الصلاحيات بعد تسجيل الدخول =====
        function applyPermissionsForCurrentUser(){
            if(!currentUser) return;
            
            // إخفاء تبويب الإعدادات إلا لسوبر أدمن فقط
            const settingsTab = document.querySelector('.nav-tab[data-tab="settings"]');
            if (settingsTab) {
                if (currentUser.role !== 'superadmin') {
                    settingsTab.style.display = 'none';
                } else {
                    settingsTab.style.display = 'flex';
                }
            }
            
            // المستخدم العادي (admin) يرى كل شيء ما عدا الإعدادات
            if(currentUser.role === 'admin'){
                // إظهار جميع البيانات بدون قيود
                document.querySelectorAll('select').forEach(select => {
                    select.disabled = false;
                    select.style.display = 'block';
                });
                
                // إظهار جميع التسميات
                document.querySelectorAll('label').forEach(label => {
                    label.style.display = 'block';
                });
                
                // إظهار جميع الفلاتر
                document.querySelectorAll('.filters').forEach(filter => {
                    filter.style.display = 'block';
                });
                
                // إظهار جميع التبويبات
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.style.display = 'flex';
                });
                
                // إعادة تعيين جميع القوائم المنسدلة
                populateRestaurantSelects();
                populateManagerSelects();
                populateVisitAreaManagerSelect();
                
            } else if(currentUser.role === 'superadmin'){
                // سوبر أدمن يرى كل شيء بما في ذلك الإعدادات
                document.querySelectorAll('select').forEach(select => {
                    select.disabled = false;
                    select.style.display = 'block';
                });
                
                document.querySelectorAll('label').forEach(label => {
                    label.style.display = 'block';
                });
                
                document.querySelectorAll('.filters').forEach(filter => {
                    filter.style.display = 'block';
                });
                
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.style.display = 'flex';
                });
                
                populateRestaurantSelects();
                populateManagerSelects();
                populateVisitAreaManagerSelect();
                
            } else if(currentUser.role === 'areaManager'){
                // الكود الحالي لمدير المنطقة
                const areaManagerName = currentUser.areaManager;
                document.querySelectorAll('select').forEach(select => {
                    if (select.id === 'dashboardManager' || select.id === 'visitAreaManager' || 
                        select.id === 'reportAreaManager' || select.id === 'problemAreaManager' || 
                        select.id === 'historyManager') {
                        select.innerHTML = `<option value="${areaManagerName}">${areaManagerName}</option>`;
                        select.disabled = true;
                    }
                });
                
                // فلتر المطاعم حسب مدير المنطقة
                const restaurantSelects = ['restaurant', 'reportRestaurant', 'problemRestaurant', 'historyRestaurant', 'dashboardRestaurant'];
                restaurantSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="all">جميع المطاعم</option>';
                        const filteredRestaurants = restaurantsData.filter(r => r.areaManager === areaManagerName);
                        filteredRestaurants.forEach(restaurant => {
                            const option = document.createElement('option');
                            option.value = restaurant.name;
                            option.textContent = restaurant.name;
                            select.appendChild(option);
                        });
                    }
                });
                
                // إخفاء فلتر مديري العمليات
                document.querySelectorAll('select[id$="Operations"]').forEach(select => {
                    select.style.display = 'none';
                    if (select.previousElementSibling && select.previousElementSibling.tagName === 'LABEL') {
                        select.previousElementSibling.style.display = 'none';
                    }
                });
                
            } else if(currentUser.role === 'operationsManager'){
                // الكود الحالي لمدير العمليات
                const operationsManagerName = currentUser.name;
                document.querySelectorAll('select[id$="Operations"]').forEach(select => {
                    select.innerHTML = `<option value="${operationsManagerName}">${operationsManagerName}</option>`;
                    select.disabled = true;
                });
                
                // فلتر مديري المناطق حسب مدير العمليات
                const areaManagerSelects = ['dashboardManager', 'visitAreaManager', 'reportAreaManager', 'problemAreaManager', 'historyManager'];
                areaManagerSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="all">جميع المدراء</option>';
                        const filteredManagers = [...new Set(restaurantsData
                            .filter(r => r.operationsManager === operationsManagerName)
                            .map(r => r.areaManager))];
                        
                        filteredManagers.forEach(manager => {
                            const option = document.createElement('option');
                            option.value = manager;
                            option.textContent = manager;
                            select.appendChild(option);
                        });
                    }
                });
                
                // فلتر المطاعم حسب مدير العمليات
                const restaurantSelects = ['restaurant', 'reportRestaurant', 'problemRestaurant', 'historyRestaurant', 'dashboardRestaurant'];
                restaurantSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="all">جميع المطاعم</option>';
                        const filteredRestaurants = restaurantsData.filter(r => r.operationsManager === operationsManagerName);
                        filteredRestaurants.forEach(restaurant => {
                            const option = document.createElement('option');
                            option.value = restaurant.name;
                            option.textContent = restaurant.name;
                            select.appendChild(option);
                        });
                    }
                });
            } else if(currentUser.role === 'restaurant'){
                // صلاحيات المطعم - يرى فقط مطعمه
                
                const restaurantName = currentUser.restaurant;
                
                // === التعديلات المحسنة للمستخدمين من نوع مطعم ===
                
                // 1. إظهار جميع الفلاتر في جميع الشاشات
                document.querySelectorAll('.filters').forEach(filter => {
                    filter.style.display = 'block';
                });
                
                // 2. إظهار جميع عناصر واجهة المستخدم المهمة
                document.querySelectorAll('select').forEach(select => {
                    select.style.display = 'block';
                    select.disabled = false;
                });
                
                document.querySelectorAll('label').forEach(label => {
                    label.style.display = 'block';
                });
                
                // 3. تعطيل فقط الفلاتر التي لا يحتاجها مستخدم المطعم
                const disabledSelects = [
                    'dashboardOperations', 'dashboardManager', 'dashboardRestaurant',
                    'reportOperations', 'reportAreaManager', 'reportRestaurant', 
                    'problemOperations', 'problemAreaManager', 'problemRestaurant',
                    'historyManager', 'historyRestaurant'
                ];
                
                disabledSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.disabled = true;
                        select.style.display = 'none';
                        // إخفاء التسمية المرتبطة
                        const label = document.querySelector(`label[for="${selectId}"]`);
                        if (label) {
                            label.style.display = 'none';
                        }
                    }
                });
                
                // 4. في شاشة تسجيل الزيارة، تعيين المطعم تلقائياً وإخفاء فلتر المطاعم
                const visitRestaurantSelect = document.getElementById('restaurant');
                if (visitRestaurantSelect) {
                    visitRestaurantSelect.innerHTML = `<option value="${restaurantName}">${restaurantName}</option>`;
                    visitRestaurantSelect.disabled = true;
                }
                
                // إخفاء فلتر مدير المنطقة في شاشة الزيارة
                const visitAreaManagerSelect = document.getElementById('visitAreaManager');
                if (visitAreaManagerSelect) {
                    visitAreaManagerSelect.style.display = 'none';
                    const visitAreaManagerLabel = document.querySelector('label[for="visitAreaManager"]');
                    if (visitAreaManagerLabel) {
                        visitAreaManagerLabel.style.display = 'none';
                    }
                }
                
                // 5. التحكم في إظهار التبويبات
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    const tabId = tab.getAttribute('data-tab');
                    // إخفاء فقط الإعدادات واللوحة الرئيسية
                    if (tabId === 'settings' || tabId === 'dashboard') {
                        tab.style.display = 'none';
                    } else {
                        tab.style.display = 'flex';
                    }
                });
                
                // 6. التأكد من إظهار أزرار التصدير في التقارير
                const exportButtons = document.querySelectorAll('#reports .btn');
                exportButtons.forEach(btn => {
                    btn.style.display = 'inline-flex';
                });
            }
            
            // إضافة بادئة توضح نوع المستخدم
            const cu = document.getElementById('currentUser');
            if(cu) {
                cu.textContent = currentUser.name + ' (' + roleText(currentUser.role) + ')';
            }
        }
        function roleText(r){
            if(r==='superadmin') return 'مدير النظام العام';
            if(r==='admin') return 'مدير النظام';
            if(r==='operationsManager') return 'مدير عمليات';
            if(r==='areaManager') return 'مدير منطقة';
            if(r==='restaurant') return 'مطعم';
            return 'مستخدم';
        }

        // ===== إدارة الشعار =====
        function loadLogo() {
            const logoUrl = localStorage.getItem('logo_url') || "https://shorturl.at/o48Nh";
            if (logoUrl) {
                document.getElementById('logoImage').src = logoUrl;
                document.getElementById('logoImage').style.display = 'block';
                document.getElementById('logoUrl').value = logoUrl;
            }
        }

        function saveLogo() {
            const logoUrl = document.getElementById('logoUrl').value.trim();
            if (logoUrl) {
                localStorage.setItem('logo_url', logoUrl);
                document.getElementById('logoImage').src = logoUrl;
                document.getElementById('logoImage').style.display = 'block';
                alert('تم حفظ الشعار بنجاح');
                logActivity('تحديث الشعار', `تم تحديث شعار النظام إلى: ${logoUrl}`);
            } else {
                alert('يرجى إدخال رابط الشعار');
            }
        }

        // ===== النسخ الاحتياطي والاسترداد =====
        function backupData() {
            const data = {
                restaurantsData,
                visitsData,
                problemsData,
                areaManagers,
                operationsManagers,
                usersData,
                userActivities,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `restaurant_visit_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('تم إنشاء نسخة احتياطية بنجاح');
            logActivity('إنشاء نسخة احتياطية', 'تم إنشاء نسخة احتياطية لجميع بيانات النظام');
        }

        function restoreData() {
            document.getElementById('importDataModal').style.display = 'flex';
        }

        function confirmImportData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('⚠️ يرجى اختيار ملف النسخة الاحتياطية');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.restaurantsData || !data.visitsData) {
                        throw new Error('الملف غير صالح أو تالف');
                    }
                    
                    if (confirm(`⚠️ هل أنت متأكد من استيراد البيانات؟\n\nهذا سيستبدل جميع البيانات الحالية!\n\n✅ المطاعم: ${data.restaurantsData?.length || 0}\n✅ الزيارات: ${data.visitsData?.length || 0}\n✅ المشاكل: ${data.problemsData?.length || 0}`)) {
                        
                        // استعادة البيانات
                        if (data.restaurantsData) restaurantsData = data.restaurantsData;
                        if (data.visitsData) visitsData = data.visitsData;
                        if (data.problemsData) problemsData = data.problemsData;
                        if (data.areaManagers) areaManagers = data.areaManagers;
                        if (data.operationsManagers) operationsManagers = data.operationsManagers;
                        if (data.usersData) {
                            usersData = data.usersData;
                            saveUsers();
                        }
                        if (data.userActivities) {
                            userActivities = data.userActivities;
                            saveActivities();
                        }
                        
                        // تحديث جميع الشاشات
                        updateAllUI();
                        
                        document.getElementById('importDataModal').style.display = 'none';
                        fileInput.value = '';
                        
                        alert('✅ تم استرداد البيانات بنجاح');
                        logActivity('استيراد نسخة احتياطية', 'تم استيراد نسخة احتياطية لجميع بيانات النظام');
                    }
                } catch (error) {
                    alert('❌ خطأ في قراءة الملف: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            reader.onerror = function() {
                alert('❌ حدث خطأ أثناء قراءة الملف');
            };
            reader.readAsText(file);
        }

        // ===== دوال مسح البيانات =====
        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع بيانات الزيارات والمشاكل؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                visitsData = [];
                problemsData = [];
                
                updateAllUI();
                
                showSyncNotification('✅ تم مسح جميع البيانات بنجاح', 'success');
                logActivity('مسح جميع البيانات', 'تم مسح جميع بيانات الزيارات والمشاكل');
            }
        }

        // ===== دوال تعبئة القوائم المنسدلة =====
        function populateRestaurantSelects() {
            // قوائم تحتوي على "جميع المطاعم" (للفلترة)
            const filterRestaurantSelects = [
                'reportRestaurant', 'problemRestaurant', 'historyRestaurant', 'dashboardRestaurant'
            ];
            
            filterRestaurantSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="all">جميع المطاعم</option>';
                    
                    restaurantsData.forEach(restaurant => {
                        const option = document.createElement('option');
                        option.value = restaurant.name;
                        option.textContent = restaurant.name;
                        select.appendChild(option);
                    });
                }
            });
            
            // قائمة التسجيل الخاصة - بدون "جميع المطاعم"
            const visitRestaurantSelect = document.getElementById('restaurant');
            if (visitRestaurantSelect) {
                visitRestaurantSelect.innerHTML = '<option value="">-- اختر المطعم --</option>';
                
                restaurantsData.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.name;
                    option.textContent = restaurant.name;
                    visitRestaurantSelect.appendChild(option);
                });
            }
        }

        function populateManagerSelects() {
            // مدراء المناطق
            const areaManagerSelects = [
                'dashboardManager', 'reportAreaManager', 'historyManager', 'problemAreaManager'
            ];
            
            areaManagerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="all">جميع المدراء</option>';
                
                areaManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            });
            
            // مدراء العمليات
            const operationsManagerSelects = [
                'dashboardOperations', 'reportOperations', 'problemOperations'
            ];
            
            operationsManagerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="all">جميع مدراء العمليات</option>';
                
                operationsManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    select.appendChild(option);
                });
            });
        }

        function populateVisitAreaManagerSelect() {
            const select = document.getElementById('visitAreaManager');
            select.innerHTML = '<option value="">-- اختر مدير المنطقة --</option>';
            
            areaManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                select.appendChild(option);
            });
        }

        // ===== دوال تحديث القوائم المنسدلة تلقائياً =====
        function updateAreaManagersByOperationsManager() {
            const operationsManager = document.getElementById('dashboardOperations').value;
            const areaManagerSelect = document.getElementById('dashboardManager');
            
            // إعادة تعيين القائمة
            areaManagerSelect.innerHTML = '<option value="all">جميع المدراء</option>';
            
            if (operationsManager === 'all') {
                // عرض جميع مديري المناطق
                areaManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            } else {
                // عرض فقط مديري المناطق التابعين لمدير العمليات المحدد
                const filteredManagers = [...new Set(restaurantsData
                    .filter(r => r.operationsManager === operationsManager)
                    .map(r => r.areaManager))];
                
                filteredManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            }
            
            // تحديث قائمة المطاعم
            updateRestaurantsByAreaManager();
        }

        function updateRestaurantsByAreaManager() {
            const operationsManager = document.getElementById('dashboardOperations').value;
            const areaManager = document.getElementById('dashboardManager').value;
            const restaurantSelect = document.getElementById('dashboardRestaurant');
            
            // إعادة تعيين القائمة
            restaurantSelect.innerHTML = '<option value="all">جميع المطاعم</option>';
            
            let filteredRestaurants = restaurantsData;
            
            if (operationsManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.operationsManager === operationsManager);
            }
            
            if (areaManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.areaManager === areaManager);
            }
            
            filteredRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });
        }

        function updateProblemAreaManagersByOperationsManager() {
            const operationsManager = document.getElementById('problemOperations').value;
            const areaManagerSelect = document.getElementById('problemAreaManager');
            
            areaManagerSelect.innerHTML = '<option value="all">جميع المدراء</option>';
            
            if (operationsManager === 'all') {
                areaManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            } else {
                const filteredManagers = [...new Set(restaurantsData
                    .filter(r => r.operationsManager === operationsManager)
                    .map(r => r.areaManager))];
                
                filteredManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            }
            
            updateProblemRestaurantsByAreaManager();
        }

        function updateProblemRestaurantsByAreaManager() {
            const operationsManager = document.getElementById('problemOperations').value;
            const areaManager = document.getElementById('problemAreaManager').value;
            const restaurantSelect = document.getElementById('problemRestaurant');
            
            restaurantSelect.innerHTML = '<option value="all">جميع المطاعم</option>';
            
            let filteredRestaurants = restaurantsData;
            
            if (operationsManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.operationsManager === operationsManager);
            }
            
            if (areaManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.areaManager === areaManager);
            }
            
            filteredRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });
        }

        function updateReportAreaManagersByOperationsManager() {
            const operationsManager = document.getElementById('reportOperations').value;
            const areaManagerSelect = document.getElementById('reportAreaManager');
            
            areaManagerSelect.innerHTML = '<option value="all">جميع المدراء</option>';
            
            if (operationsManager === 'all') {
                areaManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            } else {
                const filteredManagers = [...new Set(restaurantsData
                    .filter(r => r.operationsManager === operationsManager)
                    .map(r => r.areaManager))];
                
                filteredManagers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    areaManagerSelect.appendChild(option);
                });
            }
            
            updateReportRestaurantsByAreaManager();
        }

        function updateReportRestaurantsByAreaManager() {
            const operationsManager = document.getElementById('reportOperations').value;
            const areaManager = document.getElementById('reportAreaManager').value;
            const restaurantSelect = document.getElementById('reportRestaurant');
            
            restaurantSelect.innerHTML = '<option value="all">جميع المطاعم</option>';
            
            let filteredRestaurants = restaurantsData;
            
            if (operationsManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.operationsManager === operationsManager);
            }
            
            if (areaManager !== 'all') {
                filteredRestaurants = filteredRestaurants.filter(r => r.areaManager === areaManager);
            }
            
            filteredRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });
        }

        // ===== دوال تحميل البيانات والعروض =====
        function getFilteredData() {
            const operationsManager = document.getElementById('dashboardOperations').value;
            const areaManager = document.getElementById('dashboardManager').value;
            const restaurant = document.getElementById('dashboardRestaurant').value;
            
            let filteredVisits = [...visitsData];
            let filteredRestaurants = [...restaurantsData];
            let filteredProblems = [...problemsData];
            
            // === فلترة أولية بناءً على صلاحيات المستخدم ===
            if (currentUser) {
                switch (currentUser.role) {
                    case 'areaManager':
                        filteredVisits = filteredVisits.filter(v => v.areaManager === currentUser.areaManager);
                        filteredRestaurants = filteredRestaurants.filter(r => r.areaManager === currentUser.areaManager);
                        filteredProblems = filterProblemsByAreaManager(filteredProblems, currentUser.areaManager);
                        break;
                        
                    case 'operationsManager':
                        filteredVisits = filteredVisits.filter(v => v.operationsManager === currentUser.name);
                        filteredRestaurants = filteredRestaurants.filter(r => r.operationsManager === currentUser.name);
                        filteredProblems = filterProblemsByOperationsManager(filteredProblems, currentUser.name);
                        break;
                        
                    case 'restaurant':
                        filteredVisits = filteredVisits.filter(v => v.restaurant === currentUser.restaurant);
                        filteredRestaurants = filteredRestaurants.filter(r => r.name === currentUser.restaurant);
                        filteredProblems = filteredProblems.filter(p => p.restaurant === currentUser.restaurant);
                        break;
                        
                    case 'admin':
                    case 'superadmin':
                        // لا توجد فلترة تلقائية للمديرين
                        break;
                        
                    default:
                        console.warn('دور مستخدم غير معروف:', currentUser.role);
                }
            }
            
            // === تطبيق الفلاتر اليدوية (للمديرين أو إذا كانت محددة) ===
            
            // فلترة حسب مدير العمليات
            if (operationsManager && operationsManager !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.operationsManager === operationsManager);
                filteredRestaurants = filteredRestaurants.filter(r => r.operationsManager === operationsManager);
                filteredProblems = filterProblemsByOperationsManager(filteredProblems, operationsManager);
            }
            
            // فلترة حسب مدير المنطقة
            if (areaManager && areaManager !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.areaManager === areaManager);
                filteredRestaurants = filteredRestaurants.filter(r => r.areaManager === areaManager);
                filteredProblems = filterProblemsByAreaManager(filteredProblems, areaManager);
            }
            
            // فلترة حسب المطعم
            if (restaurant && restaurant !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.restaurant === restaurant);
                filteredRestaurants = filteredRestaurants.filter(r => r.name === restaurant);
                filteredProblems = filteredProblems.filter(p => p.restaurant === restaurant);
            }
            
            return {
                visits: filteredVisits,
                restaurants: filteredRestaurants,
                problems: filteredProblems
            };
        }

        // === دوال مساعدة للفلترة ===
        function filterProblemsByAreaManager(problems, areaManager) {
            return problems.filter(p => {
                const restaurant = restaurantsData.find(r => r.name === p.restaurant);
                return restaurant && restaurant.areaManager === areaManager;
            });
        }

        function filterProblemsByOperationsManager(problems, operationsManager) {
            return problems.filter(p => {
                const restaurant = restaurantsData.find(r => r.name === p.restaurant);
                return restaurant && restaurant.operationsManager === operationsManager;
            });
        }

        function loadDashboardStats() {
            const filteredData = getFilteredData();
            const filteredVisits = filteredData.visits;
            const filteredProblems = filteredData.problems;
            
            // حساب إحصائيات الشهر الحالي
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            const monthlyVisits = filteredVisits.filter(v => 
                v.month == currentMonth && v.year == currentYear
            );
            
            // عدد الزيارات هذا الشهر
            const monthlyVisitsCount = monthlyVisits.length;
            document.getElementById('monthlyVisitsCount').textContent = monthlyVisitsCount;
            
            // متوسط المبيعات
            const avgSales = monthlyVisits.length > 0 
                ? Math.round(monthlyVisits.reduce((sum, v) => sum + v.sales, 0) / monthlyVisits.length)
                : 0;
            document.getElementById('avgSales').textContent = avgSales;
            
            // المشاكل النشطة
            const activeProblemsCount = filteredProblems.filter(p => p.status === 'active').length;
            document.getElementById('activeProblemsCount').textContent = activeProblemsCount;
            
            // معدل رضا العملاء (محسوب بناءً على البيانات الفعلية)
            let customerSatisfaction = 0;
            if (monthlyVisits.length > 0) {
                // احسب بناءً على نسبة المشاكل إلى عدد العملاء
                const totalCustomers = monthlyVisits.reduce((sum, v) => sum + (v.customers || 0), 0);
                const totalProblems = monthlyVisits.reduce((sum, v) => sum + (v.customerProblems || 0), 0);
                
                if (totalCustomers > 0) {
                    const problemRate = totalProblems / totalCustomers;
                    // معدل الرضا = 5 نجوم ناقص نسبة المشاكل (مع بعض التعديلات)
                    customerSatisfaction = Math.max(3, 5 - (problemRate * 10)).toFixed(1);
                } else {
                    customerSatisfaction = "4.5"; // قيمة افتراضية إذا لم يكن هناك عملاء
                }
            }
            document.getElementById('customerSatisfaction').textContent = customerSatisfaction;
            
            // تحديث مؤشرات التغيير
            document.getElementById('monthlyVisitsChange').innerHTML = 
                monthlyVisitsCount > 0 ? '<span style="color: var(--success); text-align: center; display: block;"><i class="fas fa-arrow-up"></i> نشط</span>' : '';
            document.getElementById('avgSalesChange').innerHTML = 
                avgSales > 0 ? '<span style="color: var(--success); text-align: center; display: block;"><i class="fas fa-arrow-up"></i> جيد</span>' : '';
            document.getElementById('activeProblemsChange').innerHTML = 
                activeProblemsCount > 0 ? '<span style="color: var(--danger); text-align: center; display: block;"><i class="fas fa-exclamation-triangle"></i> يحتاج متابعة</span>' : '';
            document.getElementById('customerSatisfactionChange').innerHTML = 
                customerSatisfaction > 4 ? '<span style="color: var(--success); text-align: center; display: block;"><i class="fas fa-smile"></i> ممتاز</span>' : 
                customerSatisfaction > 3 ? '<span style="color: var(--warning); text-align: center; display: block;"><i class="fas fa-meh"></i> مقبول</span>' : 
                '<span style="color: var(--danger); text-align: center; display: block;"><i class="fas fa-frown"></i> يحتاج تحسين</span>';
        }

        function loadRecentVisits() {
            const container = document.getElementById('recentVisitsList');
            const filteredData = getFilteredData();
            const filteredVisits = filteredData.visits;
            
            // عرض آخر 5 زيارات فقط
            const recentVisits = filteredVisits.slice(-5).reverse();
            
            container.innerHTML = '';
            
            if (recentVisits.length === 0) {
                container.innerHTML = '<p>لا توجد زيارات حديثة</p>';
                return;
            }
            
            recentVisits.forEach(visit => {
                const visitElement = document.createElement('div');
                visitElement.className = 'visit-item';
                visitElement.innerHTML = `
                    <div class="visit-header">
                        <div class="visit-title">${visit.restaurant}</div>
                        <div class="visit-date">${getMonthName(visit.month)} ${visit.year} - الأسبوع ${visit.week}</div>
                    </div>
                    <div class="visit-details">
                        <div class="detail-item">
                            <span class="detail-label">المبيعات:</span>
                            <span class="detail-value">${visit.sales}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">عدد العملاء:</span>
                            <span class="detail-value">${visit.customers}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">متوسط الشيك:</span>
                            <span class="detail-value">${visit.avgBill}</span>
                        </div>
                    </div>
                `;
                container.appendChild(visitElement);
            });
        }

        function loadMyRestaurants() {
            const container = document.getElementById('myRestaurantsList');
            container.innerHTML = '';
            
            const filteredData = getFilteredData();
            const filteredRestaurants = filteredData.restaurants;
            
            if (filteredRestaurants.length === 0) {
                container.innerHTML = '<p>لا توجد مطاعم</p>';
                return;
            }
            
            filteredRestaurants.forEach(restaurant => {
                const hasRecentVisit = visitsData.some(v => 
                    v.restaurant === restaurant.name && 
                    isRecentVisit(v.month, v.year)
                );
                
                const listItem = document.createElement('li');
                listItem.style.padding = '12px';
                listItem.style.borderBottom = '1px solid #eee';
                listItem.style.display = 'flex';
                listItem.style.justifyContent = 'space-between';
                
                listItem.innerHTML = `
                    <span>${restaurant.name}</span>
                    <span class="badge ${hasRecentVisit ? 'badge-success' : 'badge-warning'}">
                        ${hasRecentVisit ? 'زيارة حديثة' : 'بحاجة لزيارة'}
                    </span>
                `;
                
                container.appendChild(listItem);
            });
        }

        function isRecentVisit(month, year) {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            return month == currentMonth && year == currentYear;
        }

        function loadReportData() {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            const reportYear = document.getElementById('reportYear').value;
            const restaurantFilter = document.getElementById('reportRestaurant').value;
            const areaManagerFilter = document.getElementById('reportAreaManager').value;
            const operationsManagerFilter = document.getElementById('reportOperations').value;
            
            let filteredVisits = visitsData;
            
            // تطبيق الفلتر حسب نوع التقرير - التصحيح
            if (reportType === 'areaManager' && areaManagerFilter !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.areaManager === areaManagerFilter);
            } else if (reportType === 'operationsManager' && operationsManagerFilter !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.operationsManager === operationsManagerFilter);
            }
            
            // تطبيق الفلتر حسب الشهر
            if (reportMonth && reportMonth !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.month == reportMonth);
            }
            
            // تطبيق الفلتر حسب السنة
            if (reportYear && reportYear !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.year == reportYear);
            }
            
            // تطبيق الفلتر حسب المطعم
            if (restaurantFilter && restaurantFilter !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.restaurant === restaurantFilter);
            }
            
            // تطبيق الفلتر حسب مدير المنطقة
            if (areaManagerFilter && areaManagerFilter !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.areaManager === areaManagerFilter);
            }
            
            // تطبيق الفلتر حسب مدير العمليات
            if (operationsManagerFilter && operationsManagerFilter !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.operationsManager === operationsManagerFilter);
            }
            
            if (filteredVisits.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="17" style="text-align: center; padding: 20px;">لا توجد زيارات متطابقة مع معايير البحث</td>`;
                tbody.appendChild(row);
                return;
            }
            
            filteredVisits.forEach(visit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${visit.restaurant}</td>
                    <td>${getMonthName(visit.month)} ${visit.year}</td>
                    <td>${visit.week}</td>
                    <td>${visit.sales}</td>
                    <td>${visit.customers}</td>
                    <td>${visit.avgBill}</td>
                    <td>${visit.customerProblems || 0}</td>
                    <td>${visit.itProblems || '-'}</td>
                    <td>${visit.plumbingProblems || '-'}</td>
                    <td>${visit.maintenanceHeater || '-'}</td>
                    <td>${visit.maintenanceAC || '-'}</td>
                    <td>${visit.training || '-'}</td>
                    <td>${visit.quality || '-'}</td>
                    <td>${visit.licenses || '-'}</td>
                    <td>${visit.operationalTools || '-'}</td>
                    <td>${visit.suggestions || '-'}</td>
                    <td>${visit.other || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            // تحديث تفاصيل التقرير
            updateReportDetails(filteredVisits.length);
        }

        function updateReportDetails(visitsCount) {
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            const reportYear = document.getElementById('reportYear').value;
            const areaManagerFilter = document.getElementById('reportAreaManager').value;
            const operationsManagerFilter = document.getElementById('reportOperations').value;
            
            let details = `عدد الزيارات: ${visitsCount}`;
            
            // التصحيح هنا
            if (reportType === 'areaManager' && areaManagerFilter !== 'all') {
                details += ` | مدير المنطقة: ${areaManagerFilter}`;
            } else if (reportType === 'operationsManager' && operationsManagerFilter !== 'all') {
                details += ` | مدير العمليات: ${operationsManagerFilter}`;
            } else {
                details += ' | تقرير عام';
            }
            
            if (reportMonth && reportMonth !== 'all') {
                details += ` | الشهر: ${getMonthName(reportMonth)}`;
            }
            
            if (reportYear && reportYear !== 'all') {
                details += ` | السنة: ${reportYear}`;
            }
            
            if (areaManagerFilter && areaManagerFilter !== 'all') {
                details += ` | مدير المنطقة: ${areaManagerFilter}`;
            }
            
            if (operationsManagerFilter && operationsManagerFilter !== 'all') {
                details += ` | مدير العمليات: ${operationsManagerFilter}`;
            }
            
            document.getElementById('reportDetails').textContent = details;
        }

        // ===== دالة فلترة المشاكل =====
        function getFilteredProblemsData() {
            let filteredProblems = problemsData;
            
            // إذا كان المستخدم admin أو superadmin، لا توجد فلترة تلقائية
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin')) {
                // سيتم تطبيق الفلاتر اليدوية فقط
            } else {
                // فلترة تلقائية بناءً على صلاحيات المستخدم
                if (currentUser && currentUser.role === 'areaManager') {
                    filteredProblems = filteredProblems.filter(p => {
                        const restaurant = restaurantsData.find(r => r.name === p.restaurant);
                        return restaurant && restaurant.areaManager === currentUser.areaManager;
                    });
                } else if (currentUser && currentUser.role === 'operationsManager') {
                    filteredProblems = filteredProblems.filter(p => {
                        const restaurant = restaurantsData.find(r => r.name === p.restaurant);
                        return restaurant && restaurant.operationsManager === currentUser.name;
                    });
                } else if (currentUser && currentUser.role === 'restaurant') {
                    filteredProblems = filteredProblems.filter(p => p.restaurant === currentUser.restaurant);
                }
            }
            
            // الآن تطبيق الفلاتر اليدوية من واجهة المستخدم
            const operationsManager = document.getElementById('problemOperations').value;
            const areaManager = document.getElementById('problemAreaManager').value;
            const restaurant = document.getElementById('problemRestaurant').value;
            const problemType = document.getElementById('problemType').value;
            const problemStatus = document.getElementById('problemStatus').value;
            
            // تطبيق الفلتر حسب مدير العمليات
            if (operationsManager && operationsManager !== 'all') {
                filteredProblems = filteredProblems.filter(p => {
                    const rest = restaurantsData.find(r => r.name === p.restaurant);
                    return rest && rest.operationsManager === operationsManager;
                });
            }
            
            // تطبيق الفلتر حسب مدير المنطقة
            if (areaManager && areaManager !== 'all') {
                filteredProblems = filteredProblems.filter(p => {
                    const rest = restaurantsData.find(r => r.name === p.restaurant);
                    return rest && rest.areaManager === areaManager;
                });
            }
            
            // تطبيق الفلتر حسب المطعم
            if (restaurant && restaurant !== 'all') {
                filteredProblems = filteredProblems.filter(p => p.restaurant === restaurant);
            }
            
            // تطبيق الفلتر حسب نوع المشكلة
            if (problemType && problemType !== 'all') {
                filteredProblems = filteredProblems.filter(p => p.type === problemType);
            }
            
            // تطبيق الفلتر حسب حالة المشكلة
            if (problemStatus && problemStatus !== 'all') {
                filteredProblems = filteredProblems.filter(p => p.status === problemStatus);
            }
            
            return filteredProblems;
        }

        function loadProblems() {
            const container = document.getElementById('problemsList');
            container.innerHTML = '';
            
            const filteredProblems = getFilteredProblemsData();
            
            if (filteredProblems.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">لا توجد مشاكل متطابقة مع معايير البحث</p>';
                return;
            }
            
            filteredProblems.forEach(problem => {
                const problemElement = document.createElement('div');
                problemElement.className = `problem-item ${problem.status === 'resolved' ? 'resolved' : ''}`;
                
                const resolvedDate = problem.resolvedDate ? ` - تم الحل في: ${problem.resolvedDate}` : '';
                
                problemElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>${getProblemTypeText(problem.type)} - ${problem.restaurant}</strong>
                        <span style="color: ${problem.status === 'resolved' ? 'var(--success)' : 'var(--danger)'};">
                            ${problem.status === 'resolved' ? 'تم الحل' : 'نشطة'}
                        </span>
                    </div>
                    <p>${problem.description}</p>
                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                        ${getMonthName(problem.month)} ${problem.year} - الأسبوع ${problem.week}${resolvedDate}
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        ${problem.status !== 'resolved' ? `
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;" onclick="resolveProblem(${problem.id})">
                                <i class="fas fa-check"></i> تم الحل
                            </button>
                        ` : ''}
                        ${currentUser && currentUser.role !== 'restaurant' ? `
                            <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.9rem;" onclick="deleteProblem(${problem.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(problemElement);
            });
        }

        function getProblemTypeText(type) {
            const types = {
                'it': 'مشكلة IT',
                'plumbing': 'مشكلة سباكة',
                'maintenance_heater': 'مشكلة صيانة (سخان-كهرباء)',
                'maintenance_ac': 'مشكلة صيانة (تكييف-بارد)',
                'quality': 'مشكلة جودة',
                'training': 'مشكلة تدريب',
                'licenses': 'مشكلة تراخيص',
                'tools': 'مشكلة أدوات تشغيل'
            };
            return types[type] || 'مشكلة';
        }

        function resolveProblem(problemId) {
            const problem = problemsData.find(p => p.id === problemId);
            if (problem) {
                problem.status = 'resolved';
                problem.resolvedDate = new Date().toISOString().split('T')[0];
                loadProblems();
                loadDashboardStats();
                logActivity('حل مشكلة', `تم حل المشكلة في المطعم ${problem.restaurant} - نوع المشكلة: ${getProblemTypeText(problem.type)}`);
                syncAfterOperation('resolveProblem', problem);
            }
        }

        function deleteProblem(problemId) {
            const problem = problemsData.find(p => p.id === problemId);
            if (!problem) return;
            
            if (confirm('هل أنت متأكد من حذف هذه المشكلة؟')) {
                problemsData = problemsData.filter(p => p.id !== problemId);
                loadProblems();
                loadDashboardStats();
                logActivity('حذف مشكلة', `تم حذف المشكلة من المطعم ${problem.restaurant} - نوع المشكلة: ${getProblemTypeText(problem.type)}`);
                syncAfterOperation('deleteProblem', problem);
            }
        }

        function loadVisitsHistory() {
            const container = document.getElementById('visitsHistoryList');
            container.innerHTML = '';
            
            const historyRestaurant = document.getElementById('historyRestaurant').value;
            const historyMonth = document.getElementById('historyMonth').value;
            const historyYear = document.getElementById('historyYear').value;
            const historyManager = document.getElementById('historyManager').value;
            
            let filteredVisits = [...visitsData];
            
            // === تطبيق الفلاتر ===
            if (historyRestaurant && historyRestaurant !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.restaurant === historyRestaurant);
            }
            
            if (historyMonth && historyMonth !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.month == historyMonth);
            }
            
            if (historyYear && historyYear !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.year == historyYear);
            }
            
            if (historyManager && historyManager !== 'all') {
                filteredVisits = filteredVisits.filter(v => v.areaManager === historyManager);
            }
            
            // === التحقق من وجود بيانات ===
            if (filteredVisits.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">لا توجد زيارات سابقة متطابقة مع معايير البحث</p>';
                return;
            }
            
            // === ترتيب الزيارات من الأحدث إلى الأقدم ===
            filteredVisits.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                if (a.month !== b.month) return b.month - a.month;
                return b.week - a.week;
            });
            
            // === عرض الزيارات ===
            filteredVisits.forEach(visit => {
                const visitElement = createVisitHistoryElement(visit);
                container.appendChild(visitElement);
            });
        }

        // === دالة مساعدة لإنشاء عنصر زيارة ===
        function createVisitHistoryElement(visit) {
            const visitElement = document.createElement('div');
            visitElement.className = 'visit-item';
            
            // === إنشاء أزرار الإجراءات بناءً على صلاحيات المستخدم ===
            const actionButtons = createActionButtons(visit);
            
            visitElement.innerHTML = `
                <div class="visit-header">
                    <div class="visit-title">${visit.restaurant}</div>
                    <div class="visit-date">${getMonthName(visit.month)} ${visit.year} - الأسبوع ${visit.week}</div>
                </div>
                <div class="visit-details">
                    <div class="detail-item">
                        <span class="detail-label">المبيعات:</span>
                        <span class="detail-value">${visit.sales.toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">عدد العملاء:</span>
                        <span class="detail-value">${visit.customers.toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">متوسط الشيك:</span>
                        <span class="detail-value">${visit.avgBill}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">مشاكل العملاء:</span>
                        <span class="detail-value">${visit.customerProblems || 0}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">مدير المنطقة:</span>
                        <span class="detail-value">${visit.areaManager}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">مدير العمليات:</span>
                        <span class="detail-value">${visit.operationsManager}</span>
                    </div>
                </div>
                ${actionButtons}
            `;
            
            return visitElement;
        }

        // === دالة مساعدة لإنشاء أزرار الإجراءات ===
        function createActionButtons(visit) {
            if (!currentUser) return '';
            
            let buttons = '';
            
            switch (currentUser.role) {
                case 'restaurant':
                    // للمطعم: زر التعديل فقط
                    buttons = `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-warning" onclick="editVisit(${visit.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'areaManager':
                    // لمدير المنطقة: التعديل والحذف للزيارات في منطقته فقط
                    if (visit.areaManager === currentUser.areaManager) {
                        buttons = `
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-warning" onclick="editVisit(${visit.id})">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="btn btn-danger" onclick="deleteVisit(${visit.id})">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        `;
                    }
                    break;
                    
                case 'operationsManager':
                    // لمدير العمليات: التعديل والحذف للزيارات في منطقته فقط
                    if (visit.operationsManager === currentUser.name) {
                        buttons = `
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-warning" onclick="editVisit(${visit.id})">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="btn btn-danger" onclick="deleteVisit(${visit.id})">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        `;
                    }
                    break;
                    
                case 'admin':
                case 'superadmin':
                    // للمديرين: جميع الصلاحيات
                    buttons = `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-warning" onclick="editVisit(${visit.id})">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-danger" onclick="deleteVisit(${visit.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    `;
                    break;
                    
                default:
                    // لا توجد أزرار للمستخدمين غير المعروفين
                    buttons = '';
            }
            
            return buttons;
        }

        function loadSettingsData() {
            loadOperationsManagersList();
            loadAreaManagersList();
            loadRestaurantsManagementList();
            loadUsersList();
            loadActivitiesList();
        }

        // ===== دوال إدارة المستخدمين =====
        function loadUsersList() {
            const container = document.getElementById('usersList');
            if (!container) return;
            container.innerHTML = '';
            if (!usersData || usersData.length === 0) {
                container.innerHTML = '<p>لا يوجد مستخدمين</p>';
                return;
            }
            usersData.forEach(u => {
                const div = document.createElement('div');
                div.className = 'manager-card';
                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h4 style="margin:0 0 5px 0;color:var(--primary);">${u.name}</h4>
                            <p style="margin:0;color:#666;font-size:0.9rem;">دور: ${roleText(u.role)} ${u.areaManager?(' | مدير منطقة: '+u.areaManager):''} ${u.restaurant?(' | مطعم: '+u.restaurant):''}</p>
                        </div>
                        <div class="manager-actions">
                            <button class="btn btn-primary user-action-btn" onclick="editUser(${u.id})"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-danger user-action-btn" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i> حذف</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openAddUserModal(){
            // build modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display='flex';
            modal.style.zIndex='100000';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h3 class="modal-title">إضافة مستخدم</h3><button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button></div>
                    <div class="form-group"><label>الاسم</label><input id="newUserName"></div>
                    <div class="form-group"><label>كلمة المرور</label><input id="newUserPassword" type="password"></div>
                    <div class="form-group"><label>الدور</label>
                        <select id="newUserRole">
                            <option value="areaManager">مدير منطقة</option>
                            <option value="operationsManager">مدير عمليات</option>
                            <option value="restaurant">مطعم</option>
                            <option value="admin">مدير النظام</option>
                            <option value="superadmin">مدير النظام العام</option>
                        </select>
                    </div>
                    <div class="form-group" id="areaManagerField" style="display:none;">
                        <label>مدير المنطقة</label>
                        <select id="newUserAreaManager">
                            <option value="">-- اختر مدير المنطقة --</option>
                        </select>
                    </div>
                    <div class="form-group" id="restaurantField" style="display:none;">
                        <label>المطعم</label>
                        <select id="newUserRestaurant">
                            <option value="">-- اختر المطعم --</option>
                        </select>
                    </div>
                    <div style="margin-top:10px;display:flex;gap:8px;">
                        <button class="btn btn-success" id="confirmAddUser">حفظ</button>
                        <button class="btn btn-primary close-modal" onclick="this.closest('.modal').remove()">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // تعبئة قائمة مديري المناطق
            const areaSelect = document.getElementById('newUserAreaManager');
            areaSelect.innerHTML = '<option value="">-- اختر مدير المنطقة --</option>';
            areaManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                areaSelect.appendChild(option);
            });
            
            // تعبئة قائمة المطاعم
            const restaurantSelect = document.getElementById('newUserRestaurant');
            restaurantSelect.innerHTML = '<option value="">-- اختر المطعم --</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });
            
            // إظهار/إخفاء الحقول حسب الدور
            document.getElementById('newUserRole').addEventListener('change', function() {
                const role = this.value;
                const areaManagerField = document.getElementById('areaManagerField');
                const restaurantField = document.getElementById('restaurantField');
                
                if (role === 'areaManager') {
                    areaManagerField.style.display = 'block';
                    restaurantField.style.display = 'none';
                } else if (role === 'restaurant') {
                    areaManagerField.style.display = 'none';
                    restaurantField.style.display = 'block';
                } else {
                    areaManagerField.style.display = 'none';
                    restaurantField.style.display = 'none';
                }
            });
            
            document.getElementById('confirmAddUser').addEventListener('click', confirmAddUser);
        }

        function confirmAddUser(){
            const name = document.getElementById('newUserName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const areaManager = role === 'areaManager' ? document.getElementById('newUserAreaManager').value : null;
            const restaurant = role === 'restaurant' ? document.getElementById('newUserRestaurant').value : null;
            
            if(!name || !password){ alert('الرجاء إدخال الاسم وكلمة المرور'); return; }
            if(usersData.some(u=>u.name.toLowerCase()===name.toLowerCase())){ alert('المستخدم موجود مسبقاً'); return; }
            if(role === 'areaManager' && !areaManager){ alert('يرجى اختيار مدير المنطقة'); return; }
            if(role === 'restaurant' && !restaurant){ alert('يرجى اختيار المطعم'); return; }
            
            const newId = usersData.length?Math.max(...usersData.map(u=>u.id))+1:1;
            const newUser = {id:newId, name:name, password:password, role:role};
            if (areaManager) newUser.areaManager = areaManager;
            if (restaurant) newUser.restaurant = restaurant;
            
            usersData.push(newUser);
            saveUsers();
            loadUsersList();
            // close any open modal
            document.querySelectorAll('.modal').forEach(m=>m.remove());
            alert('تمت إضافة المستخدم');
            logActivity('إضافة مستخدم', `تم إضافة المستخدم ${name} بدور ${roleText(role)}`);
            syncAfterOperation('addUser', newUser);
        }

        function editUser(id){
            const u = usersData.find(x=>x.id===id); if(!u) return;
            const modal = document.createElement('div');
            modal.className='modal'; modal.style.display='flex'; modal.style.zIndex='100000';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h3 class="modal-title">تعديل المستخدم</h3><button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button></div>
                    <div class="form-group"><label>الاسم</label><input id="editUserName" value="${u.name}"></div>
                    <div class="form-group"><label>كلمة المرور (اتركها إن لم تتغير)</label><input id="editUserPassword" type="password" placeholder="كلمة مرور جديدة">
                    </div>
                    <div class="form-group"><label>الدور</label>
                        <select id="editUserRole">
                            <option value="areaManager">مدير منطقة</option>
                            <option value="operationsManager">مدير عمليات</option>
                            <option value="restaurant">مطعم</option>
                            <option value="admin">مدير النظام</option>
                        </select>
                    </div>
                    <div class="form-group" id="editAreaManagerField" style="display:none;">
                        <label>مدير المنطقة</label>
                        <select id="editUserAreaManager">
                            <option value="">-- اختر مدير المنطقة --</option>
                        </select>
                    </div>
                    <div class="form-group" id="editRestaurantField" style="display:none;">
                        <label>المطعم</label>
                        <select id="editUserRestaurant">
                            <option value="">-- اختر المطعم --</option>
                        </select>
                    </div>
                    <div style="margin-top:10px;display:flex;gap:8px;">
                        <button class="btn btn-success" id="confirmEditUser">حفظ</button>
                        <button class="btn btn-primary close-modal" onclick="this.closest('.modal').remove()">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // تعبئة قائمة مديري المناطق
            const areaSelect = document.getElementById('editUserAreaManager');
            areaSelect.innerHTML = '<option value="">-- اختر مدير المنطقة --</option>';
            areaManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                if (manager === u.areaManager) {
                    option.selected = true;
                }
                areaSelect.appendChild(option);
            });
            
            // تعبئة قائمة المطاعم
            const restaurantSelect = document.getElementById('editUserRestaurant');
            restaurantSelect.innerHTML = '<option value="">-- اختر المطعم --</option>';
            restaurantsData.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                if (restaurant.name === u.restaurant) {
                    option.selected = true;
                }
                restaurantSelect.appendChild(option);
            });
            
            // set role select
            document.getElementById('editUserRole').value = u.role;
            
            // إظهار/إخفاء الحقول حسب الدور
            if (u.role === 'areaManager') {
                document.getElementById('editAreaManagerField').style.display = 'block';
            } else if (u.role === 'restaurant') {
                document.getElementById('editRestaurantField').style.display = 'block';
            }
            
            document.getElementById('editUserRole').addEventListener('change', function() {
                const role = this.value;
                const areaManagerField = document.getElementById('editAreaManagerField');
                const restaurantField = document.getElementById('editRestaurantField');
                
                if (role === 'areaManager') {
                    areaManagerField.style.display = 'block';
                    restaurantField.style.display = 'none';
                } else if (role === 'restaurant') {
                    areaManagerField.style.display = 'none';
                    restaurantField.style.display = 'block';
                } else {
                    areaManagerField.style.display = 'none';
                    restaurantField.style.display = 'none';
                }
            });
            
            document.getElementById('confirmEditUser').addEventListener('click', ()=>confirmEditUser(id));
        }

        function confirmEditUser(id){
            const u = usersData.find(x=>x.id===id); if(!u) return;
            const name = document.getElementById('editUserName').value.trim();
            const pwd = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            const areaManager = role === 'areaManager' ? document.getElementById('editUserAreaManager').value : null;
            const restaurant = role === 'restaurant' ? document.getElementById('editUserRestaurant').value : null;
            
            if(!name){ alert('الاسم مطلوب'); return; }
            // check duplicate name
            if(usersData.some(x=>x.id!==id && x.name.toLowerCase()===name.toLowerCase())){ alert('يوجد مستخدم آخر بنفس الاسم'); return; }
            if(role === 'areaManager' && !areaManager){ alert('يرجى اختيار مدير المنطقة'); return; }
            if(role === 'restaurant' && !restaurant){ alert('يرجى اختيار المطعم'); return; }
            
            u.name = name;
            if(pwd) u.password = pwd;
            u.role = role;
            if (role === 'areaManager') {
                u.areaManager = areaManager;
                delete u.restaurant;
            } else if (role === 'restaurant') {
                u.restaurant = restaurant;
                delete u.areaManager;
            } else {
                delete u.areaManager;
                delete u.restaurant;
            }
            
            saveUsers();
            loadUsersList();
            document.querySelectorAll('.modal').forEach(m=>m.remove());
            alert('تم تعديل المستخدم');
            logActivity('تعديل مستخدم', `تم تعديل بيانات المستخدم ${name}`);
            syncAfterOperation('editUser', u);
        }

        function deleteUser(id){
            if(!confirm('هل تريد حذف المستخدم؟')) return;
            const user = usersData.find(u=>u.id===id);
            if (!user) return;
            
            usersData = usersData.filter(u=>u.id!==id);
            saveUsers();
            loadUsersList();
            alert('تم حذف المستخدم');
            logActivity('حذف مستخدم', `تم حذف المستخدم ${user.name}`);
            syncAfterOperation('deleteUser', user);
        }

        // ===== دوال إدارة المطاعم والمديرين =====
        function loadOperationsManagersList() {
            const container = document.getElementById('operationsManagersList');
            container.innerHTML = '';
            
            if (operationsManagers.length === 0) {
                container.innerHTML = '<p>لا يوجد مديري عمليات</p>';
                return;
            }
            
            operationsManagers.forEach(manager => {
                const managerElement = document.createElement('div');
                managerElement.className = 'manager-card';
                
                // حساب عدد المطاعم التابعة لهذا المدير
                const restaurantsCount = restaurantsData.filter(r => r.operationsManager === manager).length;
                const areaManagersCount = [...new Set(restaurantsData
                    .filter(r => r.operationsManager === manager)
                    .map(r => r.areaManager))].length;
                
                managerElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: var(--primary);">${manager}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                ${areaManagersCount} مدير منطقة | ${restaurantsCount} مطعم
                            </p>
                        </div>
                        <div class="restaurant-actions">
                            <button class="btn btn-danger" onclick="deleteOperationsManager('${manager}')" ${restaurantsCount > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(managerElement);
            });
        }

        function loadAreaManagersList() {
            const container = document.getElementById('areaManagersList');
            container.innerHTML = '';
            
            if (areaManagers.length === 0) {
                container.innerHTML = '<p>لا يوجد مديري مناطق</p>';
                return;
            }
            
            areaManagers.forEach(manager => {
                const managerElement = document.createElement('div');
                managerElement.className = 'manager-card';
                
                // حساب عدد المطاعم التابعة لهذا المدير
                const restaurantsCount = restaurantsData.filter(r => r.areaManager === manager).length;
                const operationsManager = restaurantsData.find(r => r.areaManager === manager)?.operationsManager || 'غير معين';
                
                managerElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: var(--primary);">${manager}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                التابع لـ: ${operationsManager} | ${restaurantsCount} مطعم
                            </p>
                        </div>
                        <div class="restaurant-actions">
                            <button class="btn btn-warning" onclick="openTransferAreaManagerModal('${manager}')">
                                <i class="fas fa-exchange-alt"></i> نقل
                            </button>
                            <button class="btn btn-danger" onclick="deleteAreaManager('${manager}')" ${restaurantsCount > 0 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(managerElement);
            });
        }

        function loadRestaurantsManagementList() {
            const container = document.getElementById('restaurantsManagementList');
            container.innerHTML = '';
            
            if (restaurantsData.length === 0) {
                container.innerHTML = '<p>لا يوجد مطاعم</p>';
                return;
            }
            
            restaurantsData.forEach(restaurant => {
                const restaurantElement = document.createElement('div');
                restaurantElement.className = 'restaurant-item';
                
                restaurantElement.innerHTML = `
                    <div>
                        <strong>${restaurant.name}</strong>
                        <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                            مدير المنطقة: ${restaurant.areaManager} | مدير العمليات: ${restaurant.operationsManager}
                        </div>
                    </div>
                    <div class="restaurant-actions">
                        <button class="btn btn-warning" onclick="transferRestaurant('${restaurant.name}')">
                            <i class="fas fa-exchange-alt"></i> نقل
                        </button>
                        <button class="btn btn-danger" onclick="deleteRestaurant('${restaurant.name}')">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                `;
                
                container.appendChild(restaurantElement);
            });
        }

        // ===== دوال إضافية للمديرين والمطاعم =====
        function addOperationsManager() {
            document.getElementById('addOperationsManagerModal').style.display = 'flex';
        }

        function confirmAddOperationsManager() {
            const name = document.getElementById('newOperationsManagerName').value.trim();
            
            if (!name) {
                alert('يرجى إدخال اسم مدير العمليات');
                return;
            }
            
            if (operationsManagers.includes(name)) {
                alert('مدير العمليات موجود مسبقاً');
                return;
            }
            
            operationsManagers.push(name);
            document.getElementById('addOperationsManagerModal').style.display = 'none';
            document.getElementById('newOperationsManagerName').value = '';
            
            // تحديث القوائم
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            loadSettingsData();
            alert('تم إضافة مدير العمليات بنجاح');
            logActivity('إضافة مدير عمليات', `تم إضافة مدير العمليات ${name}`);
            syncAfterOperation('addOperationsManager', {name: name});
        }

        function deleteOperationsManager(managerName) {
            if (confirm(`هل أنت متأكد من حذف مدير العمليات "${managerName}"؟`)) {
                operationsManagers = operationsManagers.filter(m => m !== managerName);
                loadSettingsData();
                populateManagerSelects();
                populateVisitAreaManagerSelect();
                alert('تم حذف مدير العمليات بنجاح');
                logActivity('حذف مدير عمليات', `تم حذف مدير العمليات ${managerName}`);
                syncAfterOperation('deleteOperationsManager', {name: managerName});
            }
        }

        function addAreaManager() {
            // تعبئة قائمة مديري العمليات في النموذج
            const select = document.getElementById('newAreaManagerOperations');
            select.innerHTML = '<option value="">-- اختر مدير العمليات --</option>';
            operationsManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                select.appendChild(option);
            });
            
            document.getElementById('addAreaManagerModal').style.display = 'flex';
        }

        function confirmAddAreaManager() {
            const name = document.getElementById('newAreaManagerName').value.trim();
            const operationsManager = document.getElementById('newAreaManagerOperations').value;
            
            if (!name) {
                alert('يرجى إدخال اسم مدير المنطقة');
                return;
            }
            
            if (!operationsManager) {
                alert('يرجى اختيار مدير العمليات');
                return;
            }
            
            if (areaManagers.includes(name)) {
                alert('مدير المنطقة موجود مسبقاً');
                return;
            }
            
            areaManagers.push(name);
            
            // إضافة مطعم افتراضي للمدير الجديد
            restaurantsData.push({
                name: `مطعم ${name}`,
                areaManager: name,
                operationsManager: operationsManager
            });
            
            document.getElementById('addAreaManagerModal').style.display = 'none';
            document.getElementById('newAreaManagerName').value = '';
            
            // تحديث القوائم
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            loadSettingsData();
            alert('تم إضافة مدير المنطقة بنجاح');
            logActivity('إضافة مدير منطقة', `تم إضافة مدير المنطقة ${name} التابع لـ ${operationsManager}`);
            syncAfterOperation('addAreaManager', {name: name, operationsManager: operationsManager});
        }

        function deleteAreaManager(managerName) {
            if (confirm(`هل أنت متأكد من حذف مدير المنطقة "${managerName}"؟`)) {
                areaManagers = areaManagers.filter(m => m !== managerName);
                // حذف المطاعم التابعة لهذا المدير
                restaurantsData = restaurantsData.filter(r => r.areaManager !== managerName);
                loadSettingsData();
                populateManagerSelects();
                populateVisitAreaManagerSelect();
                alert('تم حذف مدير المنطقة بنجاح');
                logActivity('حذف مدير منطقة', `تم حذف مدير المنطقة ${managerName}`);
                syncAfterOperation('deleteAreaManager', {name: managerName});
            }
        }

        function addRestaurant() {
            // تعبئة القوائم في النموذج
            const areaSelect = document.getElementById('newRestaurantAreaManager');
            const operationsSelect = document.getElementById('newRestaurantOperationsManager');
            
            areaSelect.innerHTML = '<option value="">-- اختر مدير المنطقة --</option>';
            operationsSelect.innerHTML = '<option value="">-- اختر مدير العمليات --</option>';
            
            areaManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                areaSelect.appendChild(option);
            });
            
            operationsManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                operationsSelect.appendChild(option);
            });
            
            document.getElementById('addRestaurantModal').style.display = 'flex';
        }

        function confirmAddRestaurant() {
            const name = document.getElementById('newRestaurantName').value.trim();
            const areaManager = document.getElementById('newRestaurantAreaManager').value;
            const operationsManager = document.getElementById('newRestaurantOperationsManager').value;
            
            if (!name) {
                alert('يرجى إدخال اسم المطعم');
                return;
            }
            
            if (!areaManager) {
                alert('يرجى اختيار مدير المنطقة');
                return;
            }
            
            if (!operationsManager) {
                alert('يرجى اختيار مدير العمليات');
                return;
            }
            
            if (restaurantsData.some(r => r.name === name)) {
                alert('المطعم موجود مسبقاً');
                return;
            }
            
            restaurantsData.push({
                name: name,
                areaManager: areaManager,
                operationsManager: operationsManager
            });
            
            document.getElementById('addRestaurantModal').style.display = 'none';
            document.getElementById('newRestaurantName').value = '';
            
            // تحديث القوائم
            populateRestaurantSelects();
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            loadSettingsData();
            alert('تم إضافة المطعم بنجاح');
            logActivity('إضافة مطعم', `تم إضافة المطعم ${name} - مدير المنطقة: ${areaManager} - مدير العمليات: ${operationsManager}`);
            syncAfterOperation('addRestaurant', {name: name, areaManager: areaManager, operationsManager: operationsManager});
        }

        function deleteRestaurant(restaurantName) {
            if (confirm(`هل أنت متأكد من حذف المطعم "${restaurantName}"؟`)) {
                restaurantsData = restaurantsData.filter(r => r.name !== restaurantName);
                // حذف الزيارات والمشاكل المرتبطة بهذا المطعم
                visitsData = visitsData.filter(v => v.restaurant !== restaurantName);
                problemsData = problemsData.filter(p => p.restaurant !== restaurantName);
                
                // تحديث جميع الشاشات
                updateAllUI();
                
                alert('تم حذف المطعم وجميع بياناته بنجاح');
                logActivity('حذف مطعم', `تم حذف المطعم ${restaurantName} وجميع بياناته المرتبطة`);
                syncAfterOperation('deleteRestaurant', {name: restaurantName});
            }
        }

        function transferRestaurant(restaurantName) {
            currentTransferRestaurant = restaurantName;
            const restaurant = restaurantsData.find(r => r.name === restaurantName);
            
            if (!restaurant) return;
            
            // تعبئة النموذج
            document.getElementById('transferRestaurantName').value = restaurantName;
            
            // تعبئة قائمة مديري المناطق
            const areaSelect = document.getElementById('transferToAreaManager');
            areaSelect.innerHTML = '<option value="">-- اختر مدير المنطقة --</option>';
            areaManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                if (manager === restaurant.areaManager) {
                    option.selected = true;
                }
                areaSelect.appendChild(option);
            });
            
            // تعبئة قائمة مديري العمليات
            const operationsSelect = document.getElementById('transferToOperationsManager');
            operationsSelect.innerHTML = '<option value="">-- اختر مدير العمليات --</option>';
            operationsManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                if (manager === restaurant.operationsManager) {
                    option.selected = true;
                }
                operationsSelect.appendChild(option);
            });
            
            document.getElementById('transferRestaurantModal').style.display = 'flex';
        }

        function confirmTransferRestaurant() {
            if (!currentTransferRestaurant) return;
            
            const areaManager = document.getElementById('transferToAreaManager').value;
            const operationsManager = document.getElementById('transferToOperationsManager').value;
            
            if (!areaManager || !operationsManager) {
                alert('يرجى اختيار مدير المنطقة ومدير العمليات');
                return;
            }
            
            // تحديث بيانات المطعم
            const restaurantIndex = restaurantsData.findIndex(r => r.name === currentTransferRestaurant);
            if (restaurantIndex !== -1) {
                restaurantsData[restaurantIndex].areaManager = areaManager;
                restaurantsData[restaurantIndex].operationsManager = operationsManager;
                
                // تحديث الزيارات المرتبطة بهذا المطعم
                visitsData.forEach(visit => {
                    if (visit.restaurant === currentTransferRestaurant) {
                        visit.areaManager = areaManager;
                        visit.operationsManager = operationsManager;
                    }
                });
            }
            
            document.getElementById('transferRestaurantModal').style.display = 'none';
            currentTransferRestaurant = null;
            
            // تحديث القوائم
            populateRestaurantSelects();
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            loadSettingsData();
            loadDashboardStats();
            loadRecentVisits();
            loadMyRestaurants();
            alert('تم نقل المطعم بنجاح');
            logActivity('نقل مطعم', `تم نقل المطعم ${currentTransferRestaurant} إلى مدير المنطقة ${areaManager} ومدير العمليات ${operationsManager}`);
            syncAfterOperation('transferRestaurant', {
                restaurant: currentTransferRestaurant,
                newAreaManager: areaManager,
                newOperationsManager: operationsManager
            });
        }

        function openTransferAreaManagerModal(managerName) {
            currentTransferAreaManager = managerName;
            
            // تعبئة النموذج
            document.getElementById('transferAreaManagerName').value = managerName;
            
            // تعبئة قائمة مديري العمليات
            const operationsSelect = document.getElementById('transferAreaManagerToOperations');
            operationsSelect.innerHTML = '<option value="">-- اختر مدير العمليات --</option>';
            operationsManagers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                operationsSelect.appendChild(option);
            });
            
            document.getElementById('transferAreaManagerModal').style.display = 'flex';
        }

        function confirmTransferAreaManager() {
            if (!currentTransferAreaManager) return;
            
            const operationsManager = document.getElementById('transferAreaManagerToOperations').value;
            
            if (!operationsManager) {
                alert('يرجى اختيار مدير العمليات');
                return;
            }
            
            // تحديث بيانات المطاعم التابعة لهذا المدير
            restaurantsData.forEach(restaurant => {
                if (restaurant.areaManager === currentTransferAreaManager) {
                    restaurant.operationsManager = operationsManager;
                }
            });
            
            document.getElementById('transferAreaManagerModal').style.display = 'none';
            currentTransferAreaManager = null;
            
            // تحديث القوائم
            loadSettingsData();
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            alert('تم نقل مدير المنطقة بنجاح');
            logActivity('نقل مدير منطقة', `تم نقل مدير المنطقة ${currentTransferAreaManager} إلى مدير العمليات ${operationsManager}`);
            syncAfterOperation('transferAreaManager', {
                areaManager: currentTransferAreaManager,
                newOperationsManager: operationsManager
            });
        }

        // ===== دوال مساعدة إضافية =====
        function setCurrentYear() {
            const currentYear = new Date().getFullYear();
            document.getElementById('visitYear').value = currentYear;
            document.getElementById('reportYear').value = currentYear;
            document.getElementById('historyYear').value = currentYear;
        }

        function getMonthName(monthNumber) {
            const months = [
                "", "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
            ];
            return months[parseInt(monthNumber)] || monthNumber;
        }

        // ===== معالجات الأحداث الرئيسية =====
        function setupEventHandlers() {
            // تبديل التبويبات
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // إزالة النشاط من جميع التبويبات
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // إخفاء جميع محتويات التبويبات
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // إضافة النشاط للتبويب المحدد
                    tab.classList.add('active');
                    
                    // إظهار محتوى التبويب المحدد
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // إذا كان التبويب هو الإعدادات، قم بتحميل سجل النشاطات
                    if (tabId === 'settings') {
                        loadActivitiesList();
                    }
                });
            });
            
            // معالجة نموذج تسجيل الزيارة
            document.getElementById('visitForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveVisit();
            });
            
            // تحديث قائمة المطاعم عند تغيير مدير المنطقة في شاشة تسجيل الزيارة
            document.getElementById('visitAreaManager').addEventListener('change', function() {
                updateRestaurantsByVisitAreaManager();
            });
            
            // تطبيق الفلتر على لوحة التحكم - تلقائي
            document.getElementById('dashboardOperations').addEventListener('change', function() {
                updateAreaManagersByOperationsManager();
                loadDashboardStats();
                loadRecentVisits();
                loadMyRestaurants();
            });
            
            document.getElementById('dashboardManager').addEventListener('change', function() {
                updateRestaurantsByAreaManager();
                loadDashboardStats();
                loadRecentVisits();
                loadMyRestaurants();
            });
            
            document.getElementById('dashboardRestaurant').addEventListener('change', function() {
                loadDashboardStats();
                loadRecentVisits();
                loadMyRestaurants();
            });

            // تطبيق الفلتر على التقارير - تلقائي
            document.getElementById('reportOperations').addEventListener('change', function() {
                loadReportData();
            });
            document.getElementById('reportAreaManager').addEventListener('change', function() {
                loadReportData();
            });
            document.getElementById('reportRestaurant').addEventListener('change', function() {
                loadReportData();
            });
            document.getElementById('reportMonth').addEventListener('change', function() {
                loadReportData();
            });
            document.getElementById('reportYear').addEventListener('change', function() {
                loadReportData();
            });
            document.getElementById('reportType').addEventListener('change', function() {
                loadReportData();
            });
            
            // تحديث قائمة مديري المناطق عند تغيير مدير العمليات في التقارير
            document.getElementById('reportOperations').addEventListener('change', function() {
                updateReportAreaManagersByOperationsManager();
            });
            
            // تحديث قائمة المطاعم عند تغيير مدير المنطقة في التقارير
            document.getElementById('reportAreaManager').addEventListener('change', function() {
                updateReportRestaurantsByAreaManager();
            });
            
            // تصدير PDF
            document.getElementById('exportPdf').addEventListener('click', function() {
                exportToPdf();
            });
            
            // تصدير Excel
            document.getElementById('exportExcel').addEventListener('click', function() {
                exportToExcel();
            });
            
            // إرسال عبر واتساب
            document.getElementById('sendWhatsApp').addEventListener('click', function() {
                document.getElementById('whatsappModal').style.display = 'flex';
            });
            
            // تأكيد إرسال واتساب
            document.getElementById('confirmSendWhatsApp').addEventListener('click', function() {
                sendWhatsAppReport();
            });
            
            // تطبيق الفلتر على المشاكل - تلقائي
            document.getElementById('problemOperations').addEventListener('change', function() {
                loadProblems();
            });
            document.getElementById('problemAreaManager').addEventListener('change', function() {
                loadProblems();
            });
            document.getElementById('problemRestaurant').addEventListener('change', function() {
                loadProblems();
            });
            document.getElementById('problemType').addEventListener('change', function() {
                loadProblems();
            });
            document.getElementById('problemStatus').addEventListener('change', function() {
                loadProblems();
            });
            
            // تحديث قائمة مديري المناطق عند تغيير مدير العمليات في المشاكل
            document.getElementById('problemOperations').addEventListener('change', function() {
                updateProblemAreaManagersByOperationsManager();
            });
            
            // تحديث قائمة المطاعم عند تغيير مدير المنطقة في المشاكل
            document.getElementById('problemAreaManager').addEventListener('change', function() {
                updateProblemRestaurantsByAreaManager();
            });
            
            // تطبيق الفلتر على السجل - تلقائي
            document.getElementById('historyManager').addEventListener('change', function() {
                loadVisitsHistory();
            });
            document.getElementById('historyRestaurant').addEventListener('change', function() {
                loadVisitsHistory();
            });
            document.getElementById('historyMonth').addEventListener('change', function() {
                loadVisitsHistory();
            });
            document.getElementById('historyYear').addEventListener('change', function() {
                loadVisitsHistory();
            });
            
            // أحداث جديدة للإعدادات
            document.getElementById('addOperationsManager').addEventListener('click', addOperationsManager);
            document.getElementById('confirmAddOperationsManager').addEventListener('click', confirmAddOperationsManager);
            
            document.getElementById('addAreaManager').addEventListener('click', addAreaManager);
            document.getElementById('confirmAddAreaManager').addEventListener('click', confirmAddAreaManager);
            
            document.getElementById('addRestaurant').addEventListener('click', addRestaurant);
            document.getElementById('confirmAddRestaurant').addEventListener('click', confirmAddRestaurant);
            
            document.getElementById('confirmTransferRestaurant').addEventListener('click', confirmTransferRestaurant);
            
            document.getElementById('confirmTransferAreaManager').addEventListener('click', confirmTransferAreaManager);
            
            // مسح جميع البيانات
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            // النسخ الاحتياطي والاسترداد
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            document.getElementById('confirmImportData').addEventListener('click', confirmImportData);
            
            // حفظ الشعار
            document.getElementById('saveLogo').addEventListener('click', saveLogo);
            
            // إدارة المستخدمين
            document.getElementById('addUserBtn').addEventListener('click', openAddUserModal);
            
            // إدارة سجل النشاطات
            document.getElementById('exportActivities').addEventListener('click', exportActivitiesToExcel);
            document.getElementById('clearActivities').addEventListener('click', clearActivities);
            
            // تسجيل الدخول والخروج
            document.getElementById('loginSubmit').addEventListener('click', attemptLogin);
            document.getElementById('loginCancel').addEventListener('click', ()=>{
                // clear fields
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            });
            document.getElementById('logoutBtn').addEventListener('click', doLogout);
            
            // مزامنة مع Google Sheets
            document.getElementById('syncWithGoogleSheets').addEventListener('click', syncWithGoogleSheets);
            
            // إعدادات Google Sheets
            document.getElementById('setupGoogleScript').addEventListener('click', showGoogleScriptSetup);
            document.getElementById('confirmGoogleScriptUrl').addEventListener('click', confirmGoogleScriptUrl);
            document.getElementById('testGoogleConnection').addEventListener('click', testGoogleConnection);
            document.getElementById('clearGoogleUrl').addEventListener('click', clearGoogleUrl);
            
            // المزامنة التلقائية
            document.getElementById('autoSyncToggle').addEventListener('change', function() {
                isAutoSyncEnabled = this.checked;
                localStorage.setItem('auto_sync_enabled', this.checked);
                
                if (this.checked) {
                    startAutoSync();
                    updateAutoSyncStatus('مفعل - يعمل كل 5 دقائق');
                    showSyncNotification('✅ تم تفعيل المزامنة التلقائية', 'success');
                } else {
                    stopAutoSync();
                    updateAutoSyncStatus('غير مفعل');
                    showSyncNotification('❌ تم إيقاف المزامنة التلقائية', 'warning');
                }
            });
            
            document.getElementById('testAutoSync').addEventListener('click', function() {
                if (isAutoSyncEnabled) {
                    autoSyncWithGoogleSheets();
                } else {
                    alert('⚠️ يرجى تفعيل المزامنة التلقائية أولاً');
                }
            });

            // إغلاق النماذج الجديدة
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });

            // إضافة مستمع حدث للزر Enter في شاشة الدخول
            document.getElementById('loginUsername')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('loginPassword')?.focus();
                }
            });

            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    attemptLogin();
                }
            });

            // ===== معالجات أحداث قسم الإعدادات =====
            // مسح جميع البيانات من الإعدادات
            document.getElementById('settingsClearAllData').addEventListener('click', function() {
                if (confirm('⚠️ هل أنت متأكد من مسح جميع بيانات الزيارات والمشاكل؟\n\nهذا الإجراء لا يمكن التراجع عنه!')) {
                    visitsData = [];
                    problemsData = [];
                    
                    // تحديث جميع الشاشات
                    updateAllUI();
                    
                    showSyncNotification('✅ تم مسح جميع البيانات بنجاح', 'success');
                    logActivity('مسح جميع البيانات', 'تم مسح جميع بيانات الزيارات والمشاكل من قسم الإعدادات');
                }
            });

            // نسخة احتياطية من الإعدادات
            document.getElementById('settingsBackupData').addEventListener('click', function() {
                const data = {
                    restaurantsData,
                    visitsData,
                    problemsData,
                    areaManagers,
                    operationsManagers,
                    usersData,
                    userActivities,
                    timestamp: new Date().toISOString(),
                    backupSource: 'settings'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.download = `restaurant_backup_settings_${new Date().toISOString().split('T')[0]}.json`;
                link.href = url;
                link.click();
                
                URL.revokeObjectURL(url);
                alert('✅ تم إنشاء نسخة احتياطية بنجاح من قسم الإعدادات');
                logActivity('نسخة احتياطية من الإعدادات', 'تم إنشاء نسخة احتياطية لجميع بيانات النظام');
            });

            // استرداد نسخة من الإعدادات
            document.getElementById('settingsRestoreData').addEventListener('click', function() {
                document.getElementById('importDataModal').style.display = 'flex';
            });

            // مزامنة مع جوجل من الإعدادات
            document.getElementById('settingsSyncWithGoogleSheets').addEventListener('click', function() {
                syncWithGoogleSheets();
            });
        }

        async function syncWithGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL) {
                const setup = confirm('❌ لم يتم تعيين رابط Google Script.\n\nهل تريد تعيينه الآن؟');
                if (setup) {
                    showGoogleScriptSetup();
                }
                return;
            }

            try {
                const userConfirmed = confirm(`هل تريد مزامنة جميع البيانات مع Google Sheets؟\n\n✅ الزيارات: ${visitsData.length} زيارة\n✅ المطاعم: ${restaurantsData.length} مطعم\n✅ المشاكل: ${problemsData.length} مشكلة`);
                
                if (!userConfirmed) return;

                // استخدام getElementById مباشرة للزر في الإعدادات
                const syncBtn = document.getElementById('syncWithGoogleSheets');
                if (syncBtn) {
                    const originalText = syncBtn.innerHTML;
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري المزامنة...';
                    syncBtn.disabled = true;
                }

                const dataToSync = {
                    action: 'syncData',
                    visitsData: visitsData,
                    restaurantsData: restaurantsData,
                    problemsData: problemsData,
                    usersData: usersData,
                    userActivities: userActivities,
                    timestamp: new Date().toISOString(),
                    syncUser: currentUser ? currentUser.name : 'غير معروف',
                    version: '2.0'
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(dataToSync)
                });

                if (!response.ok) {
                    throw new Error(`فشل في الاتصال: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showSyncNotification('✅ تمت المزامنة بنجاح مع Google Sheets!', 'success');
                    logActivity('مزامنة ناجحة مع Google Sheets', 
                        `تم مزامنة ${visitsData.length} زيارة و ${restaurantsData.length} مطعم و ${problemsData.length} مشكلة`);
                } else {
                    throw new Error(result.error || 'فشل في المزامنة من جانب الخادم');
                }

            } catch (error) {
                console.log('❌ خطأ في المزامنة:', error);
                let errorMessage = 'حدث خطأ أثناء المزامنة:\n';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += '• لا يمكن الاتصال بخادم Google\n';
                    errorMessage += '• تحقق من اتصال الإنترنت\n';
                    errorMessage += '• تأكد من صحة رابط Google Script\n';
                } else if (error.message.includes('404')) {
                    errorMessage += '• رابط Google Script غير صحيح\n';
                    errorMessage += '• يرجى التحقق من الرابط وإعادة تعيينه\n';
                } else {
                    errorMessage += error.message;
                }
                
                showSyncNotification('❌ ' + errorMessage, 'error');
                
            } finally {
                const syncBtn = document.getElementById('syncWithGoogleSheets');
                if (syncBtn) {
                    syncBtn.innerHTML = '<i class="fab fa-google"></i> مزامنة مع Google Sheets';
                    syncBtn.disabled = false;
                }
            }
        }

        function saveVisit() {
            const form = document.getElementById('visitForm');
            
            const restaurant = document.getElementById('restaurant').value;
            const month = document.getElementById('visitMonth').value;
            const year = document.getElementById('visitYear').value;
            const week = document.getElementById('visitWeek').value;
            
            // === التحقق المحسن من الصحة ===
            
            // التحقق من المطعم
            if (!restaurant || restaurant === "" || restaurant === "all") {
                alert('يرجى اختيار المطعم من القائمة');
                document.getElementById('restaurant').focus();
                return;
            }
            
            // التحقق من الشهر
            if (!month || month === "") {
                alert('يرجى اختيار الشهر');
                document.getElementById('visitMonth').focus();
                return;
            }
            
            // التحقق من السنة
            if (!year || year === "") {
                alert('يرجى اختيار السنة');
                document.getElementById('visitYear').focus();
                return;
            }
            
            // التحقق من الأسبوع
            if (!week || week === "") {
                alert('يرجى اختيار الأسبوع');
                document.getElementById('visitWeek').focus();
                return;
            }
            
            // === التعامل مع مدير المنطقة بناءً على نوع المستخدم ===
            let areaManager;
            
            if (currentUser && currentUser.role === 'restaurant') {
                // لمستخدمي المطاعم: الحصول على مدير المنطقة من بيانات المطعم
                const restaurantData = restaurantsData.find(r => r.name === restaurant);
                if (restaurantData && restaurantData.areaManager) {
                    areaManager = restaurantData.areaManager;
                    console.log('✅ تم تعيين مدير المنطقة تلقائياً:', areaManager);
                } else {
                    alert('❌ خطأ: لا يمكن العثور على بيانات مدير المنطقة لهذا المطعم');
                    return;
                }
            } else {
                // للمستخدمين الآخرين: استخدام القيمة من القائمة المنسدلة
                areaManager = document.getElementById('visitAreaManager').value;
                if (!areaManager || areaManager === "") {
                    alert('يرجى اختيار مدير المنطقة');
                    document.getElementById('visitAreaManager').focus();
                    return;
                }
            }
            
            // === الحصول على مدير العمليات ===
            const restaurantData = restaurantsData.find(r => r.name === restaurant);
            const operationsManager = restaurantData ? restaurantData.operationsManager : "Tarek.B";
            
            // === التحقق من عدم وجود زيارة مكررة ===
            const existingVisit = visitsData.find(v => 
                v.restaurant === restaurant && 
                v.month == month && 
                v.year == year && 
                v.week == week
            );
            
            if (existingVisit) {
                if (!confirm('يوجد زيارة مسجلة مسبقاً لهذا المطعم في نفس الشهر والأسبوع. هل تريد استبدالها؟')) {
                    return;
                }
                // حذف الزيارة القديمة
                visitsData = visitsData.filter(v => v.id !== existingVisit.id);
            }
            
            // === إنشاء كائن الزيارة الجديدة ===
            const visit = {
                id: visitsData.length > 0 ? Math.max(...visitsData.map(v => v.id)) + 1 : 1,
                restaurant: restaurant,
                month: parseInt(month),
                year: parseInt(year),
                week: parseInt(week),
                sales: parseInt(document.getElementById('sales').value) || 0,
                customers: parseInt(document.getElementById('customers').value) || 0,
                avgBill: parseFloat(document.getElementById('avgBill').value) || 0,
                customerProblems: parseInt(document.getElementById('customerProblems').value) || 0,
                itProblems: document.getElementById('itProblems').value || '',
                plumbingProblems: document.getElementById('plumbingProblems').value || '',
                maintenanceHeater: document.getElementById('maintenanceHeater').value || '',
                maintenanceAC: document.getElementById('maintenanceAC').value || '',
                training: document.getElementById('training').value || '',
                quality: document.getElementById('quality').value || '',
                licenses: document.getElementById('licenses').value || '',
                operationalTools: document.getElementById('operationalTools').value || '',
                suggestions: document.getElementById('suggestions').value || '',
                other: document.getElementById('other').value || '',
                date: new Date().toISOString().split('T')[0],
                areaManager: areaManager,
                operationsManager: operationsManager
            };
            
            // === إضافة الزيارة إلى البيانات ===
            visitsData.push(visit);
            saveAllData();
            
            // === المزامنة الفورية ===
            syncAfterOperation('saveVisit', visit);

            // === إضافة المشاكل إذا وجدت ===
            addProblemsFromVisit(visit);

            // === إعادة تعيين النموذج ===
            form.reset();
            setCurrentYear();
            
            // === تحديث جميع الشاشات ===
            updateAllUI();
            
            // === تسجيل النشاط ===
            alert('✅ تم حفظ بيانات الزيارة بنجاح!');
            logActivity('إضافة زيارة جديدة', `تم إضافة زيارة جديدة للمطعم ${restaurant} - الشهر: ${getMonthName(month)} - الأسبوع: ${week}`);
        }

        function addProblemsFromVisit(visit) {
            // مشاكل IT
            if (visit.itProblems) {
                const problem = {
                    id: problemsData.length > 0 ? Math.max(...problemsData.map(p => p.id)) + 1 : 1,
                    type: "it",
                    restaurant: visit.restaurant,
                    description: visit.itProblems,
                    status: "active",
                    date: visit.date,
                    month: visit.month,
                    year: visit.year,
                    week: visit.week
                };
                problemsData.push(problem);
                syncAfterOperation('addProblem', problem);
            }
            
            // مشاكل السباكة
            if (visit.plumbingProblems) {
                const problem = {
                    id: problemsData.length > 0 ? Math.max(...problemsData.map(p => p.id)) + 1 : 1,
                    type: "plumbing",
                    restaurant: visit.restaurant,
                    description: visit.plumbingProblems,
                    status: "active",
                    date: visit.date,
                    month: visit.month,
                    year: visit.year,
                    week: visit.week
                };
                problemsData.push(problem);
                syncAfterOperation('addProblem', problem);
            }
            
            // مشاكل الصيانة (سخان-كهرباء)
            if (visit.maintenanceHeater) {
                const problem = {
                    id: problemsData.length > 0 ? Math.max(...problemsData.map(p => p.id)) + 1 : 1,
                    type: "maintenance_heater",
                    restaurant: visit.restaurant,
                    description: visit.maintenanceHeater,
                    status: "active",
                    date: visit.date,
                    month: visit.month,
                    year: visit.year,
                    week: visit.week
                };
                problemsData.push(problem);
                syncAfterOperation('addProblem', problem);
            }
            
            // مشاكل الصيانة (تكييف-بارد)
            if (visit.maintenanceAC) {
                const problem = {
                    id: problemsData.length > 0 ? Math.max(...problemsData.map(p => p.id)) + 1 : 1,
                    type: "maintenance_ac",
                    restaurant: visit.restaurant,
                    description: visit.maintenanceAC,
                    status: "active",
                    date: visit.date,
                    month: visit.month,
                    year: visit.year,
                    week: visit.week
                };
                problemsData.push(problem);
                syncAfterOperation('addProblem', problem);
            }
        }

        function editVisit(visitId) {
            const visit = visitsData.find(v => v.id === visitId);
            if (visit) {
                currentEditVisitId = visitId;
                const container = document.getElementById('editVisitFormContainer');
                
                container.innerHTML = `
                    <form id="editVisitForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editSales">متابعة المبيعات</label>
                                <input type="number" id="editSales" value="${visit.sales}" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomers">متابعة عدد العملاء</label>
                                <input type="number" id="editCustomers" value="${visit.customers}" required>
                            </div>
                            <div class="form-group">
                                <label for="editAvgBill">متابعة متوسط الشيك</label>
                                <input type="number" step="0.001" id="editAvgBill" value="${visit.avgBill}" required>
                            </div>
                            <div class="form-group">
                                <label for="editCustomerProblems">عدد مشاكل العملاء</label>
                                <input type="number" id="editCustomerProblems" value="${visit.customerProblems || 0}">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editItProblems">متابعة مشاكل IT</label>
                                <textarea id="editItProblems" style="min-height: 45px;">${visit.itProblems || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editPlumbingProblems">متابعة مشاكل السباكة والصرف الصحي</label>
                                <textarea id="editPlumbingProblems" style="min-height: 45px;">${visit.plumbingProblems || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editMaintenanceHeater">متابعة مشاكل الصيانة (سخان - كهرباء) أمام</label>
                                <textarea id="editMaintenanceHeater" style="min-height: 45px;">${visit.maintenanceHeater || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editMaintenanceAC">متابعة مشاكل الصيانة (تكييف- بارد) رفيق</label>
                                <textarea id="editMaintenanceAC" style="min-height: 45px;">${visit.maintenanceAC || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTraining">زيارات التدريب</label>
                                <textarea id="editTraining" style="min-height: 45px;">${visit.training || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editQuality">زيارات الجودة</label>
                                <textarea id="editQuality" style="min-height: 45px;">${visit.quality || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editLicenses">التراخيص</label>
                                <textarea id="editLicenses" style="min-height: 45px;">${visit.licenses || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editOperationalTools">احتياجات أدوات التشغيل</label>
                                <textarea id="editOperationalTools" style="min-height: 45px;">${visit.operationalTools || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editSuggestions">اقتراحات</label>
                                <textarea id="editSuggestions" style="min-height: 45px;">${visit.suggestions || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="editOther">أخرى</label>
                                <textarea id="editOther" style="min-height: 45px;">${visit.other || ''}</textarea>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> حفظ التعديلات
                            </button>
                            <button type="button" class="btn btn-primary close-modal">إلغاء</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('editVisitForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveVisitEdit();
                });
                
                document.getElementById('editVisitModal').style.display = 'flex';
            }
        }

        function saveVisitEdit() {
            if (!currentEditVisitId) return;
            
            const visitIndex = visitsData.findIndex(v => v.id === currentEditVisitId);
            if (visitIndex === -1) return;
            
            const visit = visitsData[visitIndex];
            
            // تحديث بيانات الزيارة
            visitsData[visitIndex].sales = parseInt(document.getElementById('editSales').value) || 0;
            visitsData[visitIndex].customers = parseInt(document.getElementById('editCustomers').value) || 0;
            visitsData[visitIndex].avgBill = parseFloat(document.getElementById('editAvgBill').value) || 0;
            visitsData[visitIndex].customerProblems = parseInt(document.getElementById('editCustomerProblems').value) || 0;
            visitsData[visitIndex].itProblems = document.getElementById('editItProblems').value;
            visitsData[visitIndex].plumbingProblems = document.getElementById('editPlumbingProblems').value;
            visitsData[visitIndex].maintenanceHeater = document.getElementById('editMaintenanceHeater').value;
            visitsData[visitIndex].maintenanceAC = document.getElementById('editMaintenanceAC').value;
            visitsData[visitIndex].training = document.getElementById('editTraining').value;
            visitsData[visitIndex].quality = document.getElementById('editQuality').value;
            visitsData[visitIndex].licenses = document.getElementById('editLicenses').value;
            visitsData[visitIndex].operationalTools = document.getElementById('editOperationalTools').value;
            visitsData[visitIndex].suggestions = document.getElementById('editSuggestions').value;
            visitsData[visitIndex].other = document.getElementById('editOther').value;
            
            // تحديث المشاكل المرتبطة
            updateProblemsForVisit(visitsData[visitIndex]);
            
            document.getElementById('editVisitModal').style.display = 'none';
            currentEditVisitId = null;
            
            // حفظ البيانات ومزامنتها
            saveAllData();
            syncAfterOperation('editVisit', visitsData[visitIndex]);
            
            // تحديث جميع الشاشات
            updateAllUI();
            
            alert('تم تعديل الزيارة بنجاح');
            logActivity('تعديل زيارة', `تم تعديل زيارة المطعم ${visit.restaurant} - الشهر: ${getMonthName(visit.month)} - الأسبوع: ${visit.week}`);
        }

        function updateProblemsForVisit(visit) {
            // تحديث أو إضافة مشاكل IT
            updateProblemByType(visit, 'it', visit.itProblems);
            
            // تحديث أو إضافة مشاكل السباكة
            updateProblemByType(visit, 'plumbing', visit.plumbingProblems);
            
            // تحديث أو إضافة مشاكل الصيانة (سخان-كهرباء)
            updateProblemByType(visit, 'maintenance_heater', visit.maintenanceHeater);
            
            // تحديث أو إضافة مشاكل الصيانة (تكييف-بارد)
            updateProblemByType(visit, 'maintenance_ac', visit.maintenanceAC);
        }

        function updateProblemByType(visit, type, description) {
            if (description) {
                const existingProblem = problemsData.find(p => 
                    p.restaurant === visit.restaurant && 
                    p.month == visit.month && 
                    p.year == visit.year && 
                    p.week == visit.week && 
                    p.type === type
                );
                
                if (existingProblem) {
                    existingProblem.description = description;
                    syncAfterOperation('updateProblem', existingProblem);
                } else {
                    const newProblem = {
                        id: problemsData.length > 0 ? Math.max(...problemsData.map(p => p.id)) + 1 : 1,
                        type: type,
                        restaurant: visit.restaurant,
                        description: description,
                        status: "active",
                        date: new Date().toISOString().split('T')[0],
                        month: visit.month,
                        year: visit.year,
                        week: visit.week
                    };
                    problemsData.push(newProblem);
                    syncAfterOperation('addProblem', newProblem);
                }
            }
        }

        function deleteVisit(visitId) {
            const visit = visitsData.find(v => v.id === visitId);
            if (!visit) return;
            
            if (confirm('هل أنت متأكد من حذف هذه الزيارة؟')) {
                visitsData = visitsData.filter(v => v.id !== visitId);
                // حذف المشاكل المرتبطة بهذه الزيارة
                problemsData = problemsData.filter(p => 
                    !(p.restaurant === visit.restaurant && 
                      p.month == visit.month && 
                      p.year == visit.year && 
                      p.week == visit.week)
                );
                
                // حفظ البيانات ومزامنتها
                saveAllData();
                syncAfterOperation('deleteVisit', visit);
                
                updateAllUI();
                
                alert('تم حذف الزيارة بنجاح');
                logActivity('حذف زيارة', `تم حذف زيارة المطعم ${visit.restaurant} - الشهر: ${getMonthName(visit.month)} - الأسبوع: ${visit.week}`);
            }
        }

        // ===== دوال التصدير =====
        async function exportToPdf() {
            try {
                // إنشاء عنصر مؤقت لاحتواء التقرير
                const element = document.createElement('div');
                element.style.direction = 'rtl';
                element.style.padding = '25px';
                element.style.fontFamily = 'Arial, sans-serif';
                element.style.width = '100%';
                element.style.backgroundColor = 'white';
                
                // === إضافة العنصر إلى الـ DOM ===
                document.body.appendChild(element);
                
                // عنوان التقرير الرئيسي
                const reportType = document.getElementById('reportType').value;
                const reportMonth = document.getElementById('reportMonth').value;
                const reportYear = document.getElementById('reportYear').value;
                const areaManagerFilter = document.getElementById('reportAreaManager').value;
                const operationsManagerFilter = document.getElementById('reportOperations').value;
                
                let title = "تقرير زيارات المطاعم - مطاعم نايف";
                
                if (reportType === 'areaManager' && areaManagerFilter !== 'all') {
                    title = `تقرير السيد/ ${areaManagerFilter} مدير المنطقة`;
                } else if (reportType === 'operationsManager' && operationsManagerFilter !== 'all') {
                    title = `تقرير السيد/ ${operationsManagerFilter} مدير العمليات`;
                } else {
                    title = "تقرير عام لزيارات المطاعم - مطاعم نايف";
                }
                
                if (reportMonth && reportMonth !== 'all') {
                    title += ` - شهر ${getMonthName(reportMonth)}`;
                }
                
                if (reportYear && reportYear !== 'all') {
                    title += ` ${reportYear}`;
                }
                
                // إضافة العنوان الرئيسي
                const titleElement = document.createElement('h1');
                titleElement.textContent = title;
                titleElement.style.textAlign = 'center';
                titleElement.style.marginBottom = '15px';
                titleElement.style.color = '#D8334A';
                titleElement.style.borderBottom = '3px solid #4AB9DC';
                titleElement.style.paddingBottom = '15px';
                titleElement.style.fontSize = '22px';
                titleElement.style.fontWeight = 'bold';
                element.appendChild(titleElement);
                
                // إضافة تفاصيل التقرير
                const detailsElement = document.createElement('div');
                detailsElement.textContent = document.getElementById('reportDetails').textContent;
                detailsElement.style.textAlign = 'center';
                detailsElement.style.marginBottom = '25px';
                detailsElement.style.color = '#2A6B8F';
                detailsElement.style.backgroundColor = '#E6F7FF';
                detailsElement.style.padding = '15px';
                detailsElement.style.borderRadius = '8px';
                detailsElement.style.borderRight = '4px solid #4AB9DC';
                detailsElement.style.fontSize = '14px';
                detailsElement.style.fontWeight = '600';
                element.appendChild(detailsElement);
                
                // نسخ الجدول الحالي وتحسين تنسيقه
                const originalTable = document.getElementById('reportTable');
                const clonedTable = originalTable.cloneNode(true);
                
                // تحسين تنسيق الجدول
                clonedTable.style.width = '100%';
                clonedTable.style.fontSize = '10px';
                clonedTable.style.borderCollapse = 'collapse';
                clonedTable.style.marginBottom = '25px';
                clonedTable.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                
                // تحسين تنسيق الخلايا
                const allCells = clonedTable.querySelectorAll('th, td');
                allCells.forEach(cell => {
                    cell.style.padding = '8px 6px';
                    cell.style.border = '1px solid #ddd';
                    cell.style.textAlign = 'center';
                });
                
                // تحسين تنسيق رأس الجدول
                const headerCells = clonedTable.querySelectorAll('th');
                headerCells.forEach(header => {
                    header.style.backgroundColor = '#D8334A';
                    header.style.color = 'white';
                    header.style.fontWeight = 'bold';
                    header.style.fontSize = '11px';
                });
                
                // تلوين الصفوف الزوجية
                const rows = clonedTable.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    if (index % 2 === 0) {
                        row.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                element.appendChild(clonedTable);

                // === إضافة جدول الإحصاءات ===
                const summaryElement = document.createElement('div');
                summaryElement.style.marginTop = '25px';
                summaryElement.style.padding = '20px';
                summaryElement.style.backgroundColor = '#E6F7FF';
                summaryElement.style.borderRadius = '8px';
                summaryElement.style.borderRight = '4px solid #4AB9DC';
                summaryElement.style.borderLeft = '2px solid #D8334A';

                const tbody = originalTable.tBodies[0];
                const totalVisits = tbody.rows.length;
                let totalSales = 0;
                let totalCustomers = 0;
                let totalProblems = 0;

                for (let i = 0; i < tbody.rows.length; i++) {
                    const cells = tbody.rows[i].cells;
                    totalSales += parseInt(cells[3].textContent) || 0;
                    totalCustomers += parseInt(cells[4].textContent) || 0;
                    totalProblems += parseInt(cells[6].textContent) || 0;
                }

                const avgSales = totalVisits > 0 ? Math.round(totalSales / totalVisits) : 0;
                const avgCustomers = totalVisits > 0 ? Math.round(totalCustomers / totalVisits) : 0;
                const problemRate = totalCustomers > 0 ? ((totalProblems / totalCustomers) * 100).toFixed(2) : 0;

                summaryElement.innerHTML = `
                    <h3 style="color: #D8334A; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #D8334A; padding-bottom: 10px;">ملخص الإحصائيات</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">عدد الزيارات</div>
                            <div style="font-size: 18px; font-weight: bold; color: #D8334A;">${totalVisits}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">إجمالي المبيعات</div>
                            <div style="font-size: 18px; font-weight: bold; color: #D8334A;">${totalSales.toLocaleString()}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">إجمالي العملاء</div>
                            <div style="font-size: 18px; font-weight: bold; color: #D8334A;">${totalCustomers.toLocaleString()}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">متوسط المبيعات</div>
                            <div style="font-size: 18px; font-weight: bold; color: #D8334A;">${avgSales.toLocaleString()}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">متوسط العملاء</div>
                            <div style="font-size: 18px; font-weight: bold; color: #D8334A;">${avgCustomers}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border-right: 3px solid #4AB9DC;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">معدل المشاكل</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${problemRate > 5 ? '#D8334A' : '#4CAF50'};">${problemRate}%</div>
                        </div>
                    </div>
                `;

                element.appendChild(summaryElement);

                // الانتظار حتى يتم تحميل وعرض جميع الإحصاءات
                await new Promise(resolve => {
                    const checkReady = setInterval(() => {
                        if (summaryElement.offsetHeight > 100) {
                            clearInterval(checkReady);
                            resolve();
                        }
                    }, 100);
                });

                await new Promise(resolve => setTimeout(resolve, 2500));

                // إعدادات PDF
                const options = {
                    margin: [10, 10, 10, 10],
                    filename: `تقرير_زيارات_المطاعم_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { 
                        type: 'jpeg', 
                        quality: 0.95 
                    },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#FFFFFF'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a3', 
                        orientation: 'landscape'
                    }
                };
                
                // رسالة تقدم
                alert('جاري إنشاء ملف PDF...');
                
                // إنشاء PDF
                html2pdf()
                    .set(options)
                    .from(element)
                    .save()
                    .then(() => {
                        console.log('✅ تم إنشاء PDF بنجاح');
                        // تنظيف العنصر
                        if (element.parentNode) {
                            element.parentNode.removeChild(element);
                        }
                        logActivity('تصدير تقرير PDF', `تم تصدير تقرير PDF: ${title}`);
                    })
                    .catch(error => {
                        console.error('❌ خطأ في إنشاء PDF:', error);
                        // تنظيف العنصر في حالة الخطأ
                        if (element.parentNode) {
                            element.parentNode.removeChild(element);
                        }
                        alert('حدث خطأ أثناء إنشاء ملف PDF. يرجى المحاولة مرة أخرى.');
                    });
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء ملف PDF. يرجى المحاولة مرة أخرى.');
            }
        }

        // تصدير إلى Excel مع تنسيق محسن
        function exportToExcel() {
            // إنشاء مصنف جديد
            const wb = XLSX.utils.book_new();
            
            // الحصول على بيانات الجدول
            const table = document.getElementById('reportTable');
            const data = [];
            
            // عنوان التقرير
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            const reportYear = document.getElementById('reportYear').value;
            const areaManagerFilter = document.getElementById('reportAreaManager').value;
            const operationsManagerFilter = document.getElementById('reportOperations').value;
            
            let title = "تقرير زيارات المطاعم";
            
            if (reportType === 'areaManager' && areaManagerFilter !== 'all') {
                title = `تقرير السيد/ ${areaManagerFilter} مدير المنطقة`;
            } else if (reportType === 'operationsManager' && operationsManagerFilter !== 'all') {
                title = `تقرير السيد/ ${operationsManagerFilter} مدير العمليات`;
            } else {
                title = "تقرير عام لزيارات المطاعم";
            }
            
            if (reportMonth && reportMonth !== 'all') {
                title += ` لشهر ${getMonthName(reportMonth)}`;
            }
            
            if (reportYear && reportYear !== 'all') {
                title += ` سنة ${reportYear}`;
            }
            
            // إضافة العنوان كصف
            data.push([title]);
            data.push([]); // صف فارغ
            
            // إضافة تفاصيل التقرير
            data.push([document.getElementById('reportDetails').textContent]);
            data.push([]); // صف فارغ
            
            // جمع العناوين
            const headers = [];
            for (let i = 0; i < table.rows[0].cells.length; i++) {
                headers.push(table.rows[0].cells[i].innerText);
            }
            data.push(headers);
            
            // جمع البيانات
            for (let i = 1; i < table.rows.length; i++) {
                const row = [];
                for (let j = 0; j < table.rows[i].cells.length; j++) {
                    row.push(table.rows[i].cells[j].innerText);
                }
                data.push(row);
            }
            
            // إنشاء ورقة عمل
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تنسيق الأعمدة لتناسب المحتوى
            const colWidths = [];
            for (let i = 0; i < headers.length; i++) {
                let maxLength = headers[i].length;
                for (let j = 5; j < data.length; j++) {
                    if (data[j][i] && data[j][i].toString().length > maxLength) {
                        maxLength = data[j][i].toString().length;
                    }
                }
                colWidths.push({ wch: Math.min(maxLength + 2, 50) }); // تحديد عرض الأعمدة
            }
            ws['!cols'] = colWidths;
            
            // تنسيق العنوان
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } });
            ws['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: headers.length - 1 } });
            
            // إضافة الورقة إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير الزيارات');
            
            // حفظ الملف
            XLSX.writeFile(wb, 'تقرير_زيارات_المطاعم.xlsx');
            
            logActivity('تصدير تقرير Excel', `تم تصدير تقرير Excel: ${title}`);
        }

        // إرسال التقرير عبر واتساب
        function sendWhatsAppReport() {
            const phone = document.getElementById('phoneNumber').value;
            const message = document.getElementById('whatsappMessage').value;
            
            if (!phone || phone === '+965') {
                alert('يرجى إدخال رقم الهاتف');
                return;
            }
            
            // تنظيف رقم الهاتف
            const cleanPhone = phone.replace(/\D/g, '');
            
            // إنشاء نص التقرير
            const reportType = document.getElementById('reportType').value;
            const reportMonth = document.getElementById('reportMonth').value;
            const reportYear = document.getElementById('reportYear').value;
            
            let reportText = "تقرير زيارات المطاعم\n\n";
            
            if (reportType === 'areaManager') {
                reportText += "تقرير مدير المنطقة\n";
            } else if (reportType === 'operationsManager') {
                reportText += "تقرير مدير العمليات\n";
            } else {
                reportText += "تقرير عام\n";
            }
            
            if (reportMonth && reportMonth !== 'all') {
                reportText += `شهر: ${getMonthName(reportMonth)}\n`;
            }
            
            if (reportYear && reportYear !== 'all') {
                reportText += `سنة: ${reportYear}\n`;
            }
            
            reportText += `\n${document.getElementById('reportDetails').textContent}\n\n`;
            
            // إضافة ملخص البيانات
            const tbody = document.getElementById('reportTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            if (rows.length > 0) {
                reportText += "ملخص البيانات:\n";
                
                // إضافة بعض البيانات المختصرة
                for (let i = 0; i < Math.min(rows.length, 5); i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    if (cells.length > 0) {
                        reportText += `${cells[0].textContent}: مبيعات ${cells[3].textContent} - عملاء ${cells[4].textContent}\n`;
                    }
                }
                
                if (rows.length > 5) {
                    reportText += `...و ${rows.length - 5} سجل إضافي\n`;
                }
            }
            
            if (message) {
                reportText += `\nملاحظات:\n${message}\n`;
            }
            
            reportText += `\nتم إنشاء التقرير في: ${new Date().toLocaleDateString('ar-EG')}`;
            
            // تشفير النص للرابط
            const encodedText = encodeURIComponent(reportText);
            
            // إنشاء رابط واتساب
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedText}`;
            
            // فتح الرابط في نافذة جديدة
            window.open(whatsappUrl, '_blank');
            
            document.getElementById('whatsappModal').style.display = 'none';
            alert('تم فتح تطبيق واتساب مع التقرير الجاهز للإرسال');
            
            logActivity('إرسال تقرير عبر واتساب', `تم إرسال تقرير عبر واتساب إلى الرقم: ${phone}`);
        }

        // تحديث قائمة المطاعم بناءً على مدير المنطقة
        function updateRestaurantsByVisitAreaManager() {
            const areaManager = document.getElementById('visitAreaManager').value;
            const restaurantSelect = document.getElementById('restaurant');
            
            // إعادة تعيين القائمة - بدون "جميع المطاعم"
            restaurantSelect.innerHTML = '<option value="">-- اختر المطعم --</option>';
            
            if (!areaManager) {
                // إذا لم يتم اختيار مدير منطقة، عرض جميع المطاعم (وليس "جميع المطاعم")
                restaurantsData.forEach(restaurant => {
                    const option = document.createElement('option');
                    option.value = restaurant.name;
                    option.textContent = restaurant.name;
                    restaurantSelect.appendChild(option);
                });
                return;
            }
            
            // عرض فقط المطاعم التابعة لمدير المنطقة المحدد
            const filteredRestaurants = restaurantsData.filter(r => r.areaManager === areaManager);
            
            if (filteredRestaurants.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "لا توجد مطاعم لهذا المدير";
                restaurantSelect.appendChild(option);
                return;
            }
            
            filteredRestaurants.forEach(restaurant => {
                const option = document.createElement('option');
                option.value = restaurant.name;
                option.textContent = restaurant.name;
                restaurantSelect.appendChild(option);
            });
        }

        // ===== التهيئة =====
        function initApp() {
            loadUsers();
            loadActivities();
            loadGoogleScriptUrl();
            loadAutoSyncSetting();
            setupConnectionMonitoring();
            
            // تحميل البيانات من السحابة أو المحلية
            loadDataFromGoogleSheets();
            
            setupEventHandlers();
            populateRestaurantSelects();
            populateManagerSelects();
            populateVisitAreaManagerSelect();
            loadDashboardStats();
            loadRecentVisits();
            loadMyRestaurants();
            loadReportData();
            loadProblems();
            loadVisitsHistory();
            loadSettingsData();
            setCurrentYear();
            loadLogo();
            showLoginOverlay();
        }

        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

    </script>
</body>
</html>